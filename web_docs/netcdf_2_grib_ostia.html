<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>Climate Prediction Center netcdf vs grib2: ostia to grib2</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1252">
  <meta content="NCEP Web Team" name="GENERATOR">
  <meta name="keywords"
  content="Climate,Climate Prediction Center,National Weather Service,National Oceanic &amp; Atmospheric Administration, NOAA,El Nino,La Nina,ENSO,climate outlooks,El Nino Advisory,La Nina Advisory,droughts,hurricanes,Threats Assessment,Drought Assessment,Drought Monitor,CLimate Diagnostics Bulletin,6-10 day outlook,8-14 day outlook, 6-10 day forecast,8-14 day forecast,MRF,UV Index,North Atlantic Oscillation,NAO,Pacific Decadal Oscillation,PDO,sea surface temperatures,SST,Palmer Drought Severity Index, African Desk,outlooks,expert assessments,monitoring,advisories,stratosphere,temperature,precipitation,snow cover,snowfall,soil moisture,OLR,ozone,degree days,CLIMATE,CLIMATE PREDICTION CENTER,EL NINO,LA NINA, CLIMATE OUTLOOKS,HURRICANES,ASSESSMENTS,SNOW,STRATOSPHERE,DROUGHT,OZONE,DEGREE DAYS">
  <link href="/nwscwi/main.css" type="text/css" rel="STYLESHEET">
</head>
<body leftmargin="0" background="/nwscwi/background.gif" 
      topmargin="0" rightmargin="0" marginheight="0" marginwidth="0">
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/topbanner.jpg" border="0">
  <tr>
    <td align="right" height="19">
      <a href="#contents"><img height="1" alt="Skip Navigation Links"
         src="/nwscwi/skipgraphic.gif" width="1" border="0"></a>
      <a href="https://www.nws.noaa.gov/" class="homepagelinks"><span class="nwslink">www.nws.noaa.gov</span></a>&nbsp;</td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
  <tr>
    <td rowspan="2"><a href="https://www.noaa.gov/">
      <img height="78" alt="NOAA logo - Click to go to the NOAA home page"
      src="/nwscwi/noaaleft.jpg" width="85" border="0"></a></td>
    <td align="left"><img height="20" alt="National Weather Service"
      src="/nwscwi/nws_title.jpg" width="500" border="0"></td>
    <td rowspan="2" width="100%" background="/nwscwi/ncep_bkgrnd.jpg">&nbsp;</td>
    <td rowspan="2" align="right"><a href="https://www.nws.noaa.gov/">
      <img height="78" alt="NWS logo - Click to go to the NWS home page"
      src="/nwscwi/nwsright.jpg" width="85" border="0"></a></td>
  </tr>
  <tr>
    <td><img height="58" alt="Climate Prediction Center" src="/nwscwi/cpc.jpg"
             width="500" border="0"></td>    <!-- Put your center header image here. -->
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/navbkgrnd.gif" border="0">
  <tr>
    <td align="left" valign="top" width="94"><img height="23" alt="" src="/nwscwi/navbarleft.jpg" width
="94" border="0"></td>
    <td class="nav" align="center" width="15%">
      <a href="/products/site_index.html" class="menu">Site Map</a></td> <!-- Build a text only sitemap, and link to it via this
                                                    sitemap button just below the banner.
                                                    The sitemap should include a heirarchy of links
                                                    from NOAA, to the NWS, to NCEP, and then through your site. -->
    <td class="nav" align="right" width="15%">
      <a href="https://www.nws.noaa.gov/pa/" class="menu">News</a></td>
    <td class="nav" id="menuitem" align="right" width="20%">
      <a href="https://weather.gov/organization.php" class="menu">Organization</a></td>
    <td class="yellow" align="right" width="20%">
      <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
        <label for="search">Search</label>&nbsp;</td>
    <td align="left" class="searchinput" width="20%" nowrap>
      <input type="hidden" name="parsed" value="true">
      <input type="hidden" name="rn" value="3">
      <input type="hidden" name="in0" value="domain">
      <input type="hidden" name="dom0" value="nws.noaa.gov, weather.gov, wrh.noaa.gov, srh.noaa.gov, crh.noaa.gov, prh.noaa.gov, arh.noaa.gov, alaska.net/~nwsar, erh.noaa.gov, ncep.noaa.gov, wwb.noaa.gov, spc.noaa.gov, nhc.noaa.gov, sec.noaa.gov, aviationweather.gov, aviationweather.noaa.gov, weather.noaa.gov, roc.noaa.gov, nohrsc.nws.gov, nwstc.noaa.gov, wdtb.noaa.gov, npmoc.navy.mil, ndbc.noaa.gov">
      <input type="text" name="mw0" value="All NWS Search" id="search" size="20" maxlength="256">
      <input type="submit" name="Go2" value="Go"></td>
    <td width="10%">&nbsp;</form></td>
    <td align="right" valign="bottom" width="24"><img height="23" alt="" src="/nwscwi/navbarendcap.jpg"
 width="24" border="0"></td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="670" border="0">
  <tr valign="top">
    <td width="137"><br>
      <table cellspacing="0" cellpadding="2" width="137" border="0">
        <!-- Do not remove this section. You will need this when the City,St/zip search is implemented nationwide.-->
        <!-- <tr align="left" valign="top">
                <td class="searchinput">
                  <div id="Layer2" style="position:absolute; width:200px; height:115px; z-index:2; visibility: hidden">Search by city or zip code. Press enter or select the go button to submit request</div>
                  <form method="POST" action="https://www.srh.noaa.gov/zipcity.php">
                  <span class="yellow">Local forecast by<br>&quot;City, St&quot; or Zip Code</span><br>
                  <input type="text" name="inputstring" size="9" value="City, St">
                  <input type="submit" name="Go2" value="Go"></form></td>
        </tr> -->
         <tr>
          <td class="searchinput" align="left">
            <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
             <label for="search"><span class="yellow">CPC Search</span></label>
              <input type="hidden" name="parsed" value="true">
              <input type="hidden" name="rn" value="3">
              <input type="hidden" name="in0" value="domain">
              <input type="hidden" name="dom0" value="www.cpc.ncep.noaa.gov">
              <input type="text" name="mw0" id="search"  size="10" maxLength="256" value="CPC search">&nbsp;
              <input type="submit" name="Go2" value="Go">
          </form></td>
         </tr>
        <tr>
          <td class="white">
            <span class="yellow">About Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/mission.html" class="menu">Our Mission</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/" class="menu">Who We Are</a><br><br>
            <span class="yellow">Contact Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/personnel/contacts.html" class="menu">CPC Information</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/comment-form.html" class="menu">CPC Web Team</a><br><br>           
          </td>
        </tr>
      </table>
    </td>
    <td valign="top" align="center" width="533"><a name="contents"></a>

<!-- Begin content area -->
<table border="0" cellPadding="2" cellSpacing="0" align="center" width="533">
 <tr><td>&nbsp;</td></tr>

 <tr>
  <td>
   <font face="Verdana,arial,serif" size="1"><a href="/index.html" class="homepagelinks"><strong>HOME</strong></a> &gt; <a href="/products/monitoring_and_data" class="homepagelinks">Monitoring_and_Data</a> &gt; <a href="/products/monitoring_and_data/oadata.html" class="homepagelinks">Oceanic and Atmospheric Data</a> &gt; <a href="/products/wesley/" class="homepagelinks">Reanalysis: Atmospheric Data</a> &gt; netcdf vs grib2: ostia sst to grib2</font>

  </td>
 </tr>
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
<font color=red>
<h3 align=center>Example: converting netcdf to grib</h3>
</font>

<h3>Step 1: What is in the OSTIA NetCDF file?</h3>
<p>
The OSTIA SST are produced the the UK MetOfice. We had the need to
convert the SST files from netcdf to grib2.  This page will show
how wgrib2 (v3.0.0) was used to convert the daily files into grib2.
The grib files had the same grid point values. The new files were
8% of the netcdf file sizes.  The files were not 8% smaller but 8% of
the original files.  Such compressions are rare but happen
when the fields are smooth and have many undefined values like sea ice.

<p>
To start off, the file

<pre>
$ ncdump -h 20191201120000-UKMO-L4_GHRSST-SSTfnd-OSTIA-GLOB-v02.0-fv02.0.nc
netcdf \20191201120000-UKMO-L4_GHRSST-SSTfnd-OSTIA-GLOB-v02.0-fv02.0 {
dimensions:
	time = 1 ;
	lat = 3600 ;
	lon = 7200 ;

   the file has 1 time step, with a 3600x7200 grid

	short analysed_sst(time, lat, lon) ;
		analysed_sst:long_name = "analysed sea surface temperature" ;
		analysed_sst:standard_name = "sea_surface_foundation_temperature" ;
		analysed_sst:units = "kelvin" ;
		analysed_sst:coordinates = "lon lat" ;
		analysed_sst:_FillValue = -32768s ;
		analysed_sst:add_offset = 273.15f ;
		analysed_sst:scale_factor = 0.01f ;
		analysed_sst:valid_min = -300s ;
		analysed_sst:valid_max = 4500s ;
		analysed_sst:source = "(not shown)"
		analysed_sst:comment = " OSTIA foundation SST" ;

   the sst is in Kelvin, storted as a scaled short integer (2 bytes), to 1/100 of a degree

	short analysis_error(time, lat, lon) ;
		analysis_error:long_name = "estimated error standard deviation of analysed_sst" ;
		analysis_error:standard_name = "sea_surface_foundation_temperature standard_error" ;
		analysis_error:units = "kelvin" ;
		analysis_error:coordinates = "lon lat" ;
		analysis_error:_FillValue = -32768s ;
		analysis_error:add_offset = 0.f ;
		analysis_error:scale_factor = 0.01f ;
		analysis_error:valid_min = 0s ;
		analysis_error:valid_max = 32767s ;
		analysis_error:comment = " OSTIA foundation SST analysis standard deviation error" ;

   the sst error is like the sst, scaled short integer, 1/100 of adegree

	byte sea_ice_fraction(time, lat, lon) ;
		sea_ice_fraction:long_name = "sea ice area fraction" ;
		sea_ice_fraction:standard_name = "sea_ice_area_fraction" ;
		sea_ice_fraction:units = "1" ;
		sea_ice_fraction:coordinates = "lon lat" ;
		sea_ice_fraction:_FillValue = -128b ;
		sea_ice_fraction:add_offset = 0.f ;
		sea_ice_fraction:scale_factor = 0.01f ;
		sea_ice_fraction:valid_min = 0b ;
		sea_ice_fraction:valid_max = 100b ;
		sea_ice_fraction:source = "EUMETSAT OSI-SAF" ;
		sea_ice_fraction:comment = " Sea ice area fraction" ;

   the sea ice fraction is stored as a scaled byte, values to 1/100.

	byte mask(time, lat, lon) ;
		mask:long_name = "land sea ice lake bit mask" ;
		mask:coordinates = "lon lat" ;
		mask:_FillValue = -128b ;
		mask:valid_min = 1b ;
		mask:valid_max = 31b ;
		mask:flag_masks = 1b, 2b, 4b, 8b, 16b ;
		mask:flag_meanings = "water land optional_lake_surface sea_ice optional_river_surface" ;
		mask:source = "NAVOCEANO_landmask_v1.0 EUMETSAT_OSI-SAF_icemask ARCLake_lakemask" ;
		mask:comment = " Land/ open ocean/ sea ice /lake mask" ;

   the mask is stored as a byte values 0..31

   The grid definition can be obtained by using

$ ncdump 20191201120000-UKMO-L4_GHRSST-SSTfnd-OSTIA-GLOB-v02.0-fv02.0.nc
</pre>

<h3>Step 2: Making a Template File</h3>
<p>
To convert from netcdf to grib, we will use the -import_netcdf option
in wgrib2 (v3.0.0).  The first step in using wgrib2 for conversion, is
to make a template file which the same grid definition as the netcdf
fields as well as using a suitable Product Definition Template (PDT) set to
zero.  Obviously you would not want an ensemble PDT, a aerosol PDT or
any other "fancy" PDT.

<pre>
# making the template file
wgrib2 ~/grib2/examples/gep19.aec -d 1  -set_pdt +0 -set_var HGT  -new_grid_winds earth \
   -new_grid latlon 180.025000:7200:0.050000 -89.975000:3600:0.05 ostia.template.tmp

# setting grid == 0 to save space
wgrib2 ostia.template.tmp -rpn 0 -set_lev surface -grib_out ostia.template
</pre>


<h3>Step 3: wgrib2 script</h3>

<p>
To convert from netcdf to grib2, we will "wgrib2 ostia.template" and use 
<font color=red>-import_netcdf</font> to replace the grid point values. Then
change some metadata like the variable name,
and write out the data in grib format using <font color=red>-grib_out</font>.  The
translation is not automatic, and you will have to script the translation for each grid.  The script 
fragment to translate is,

<pre> (fragment of script to convert years of SST files) 
    19  $wgrib2 ~/home/fv3/fixed/ostia.template \
    20   -import_netcdf $file  \
    21    "sea_ice_fraction" "0:1:0:3600:0:7200" \
    22    -set_var ICEC -set_scaling -2 0 -set center 254 -set_grib_type c1 -set_date $date \
    23    -grib_out $new_file \
    24   -import_netcdf $file  \
    25    analysed_sst "0:1:0:3600:0:7200" \
    26    -set_var TMP -set center 74 -set center 74 -set_date $date \
    27     -set_scaling -2 0 -set_grib_type c3 -grib_out $new_file \
    28   -import_netcdf $file  \
    29    mask "0:1:0:3600:0:7200" \
    30    -set_var MASK -set center 74 -set_date $date \
    31     -set_scaling -2 0 -set_grib_type c1 -grib_out $new_file \
    32   -import_netcdf $file \
    33     analysis_error "0:1:0:3600:0:7200" \
    34    -set_var TMP -set table_4.3 7 -set center 74 -set_date $date \
    35     -set_scaling -2 0 -set_grib_type c3 -grib_out $new_file

        19:     ostia.template is a grib with the same grid as the ostia sst
                was created using wgrib2's -new_grid option (see step 2)
        20-23:  read sea_ice_fraction (netcdf name) and write as grib
        22:     set grib name to ICEC
                set to 2 digits after the decimal point
                set center to 254
                set complex packing version 1 (best)
        23:     write grib to $new_file

        24-27:  read analysed_sst, write as TMP:sfc
        27:     set scaling to 2 digits after the decimal place
                set to complex packing version 3  (best)

        28:31:  read mask (netcdf name), write out MASK

        32:35:  read analyis_error (netcdf name), write out at TMP:sfc with type set to error
        34:     to signify error, table 4.3 has to have the value 7
</pre>

<h3>Results: Compression </h3>
<p>
The NetCDF4 file was 15952413 bytes (20191201120000), and after
comversion to grib2, the file was 13872380 bytes. Converting
to grib reduces the size by 13%.  The grib2 compression will depend
on the the program that does the encoding and which compression
method is used.  The above conversion requires wgrib2 v3.0.0+.



<p>
See also:
<a href="./grib_out.html">-grib_out</a>,
<a href="./import_netcdf">-import_netcdf</a>,
<a href="./new_grid.html">-new_grid</a>,
<a href="./set.html">-set</a>,
<a href="./set_lev.html">-set_lev</a>,
<a href="./set_var.html">-set_var</a>,
</td>
</tr>


<!--  End of Content area  --><html><body></body></html>
<!--   ...............................................Footer Portion.........................................    -->
 <tr>
  <td>
   <table width="500">
    <tr>
     <td colSpan="3"><hr></td>
    </tr>
    <TR vAlign="top">
     <TD class="gray">
      <A href="https://www.noaa.gov/" class="homepagelinks"><SPAN class="gray">NOAA/</SPAN></A>
      <A href="https://www.nws.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Weather Service</SPAN></A><BR>
      <A href="https://www.ncep.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Centers for Environmental Prediction</SPAN></a><BR>
        Climate Prediction Center<BR>
        5830 University Research Court<BR>
        College Park, Maryland 20740<BR>
      <A href="/comment-form.html" class="homepagelinks"><SPAN class="gray">Climate Prediction Center Web Team</SPAN></A><BR>
        Page created 1/9/2020.
     </TD>
     <TD>
      <A href="https://weather.gov/disclaimer.php" class="homepagelinks"><SPAN class="gray">Disclaimer</SPAN></A>
     </TD>
     <TD align="right">
      <A href="https://weather.gov/privacy.php" class="homepagelinks"> <SPAN class="gray">Privacy Policy</SPAN></A>
     </TD>
    </TR>
   </table>
  </td>
 </tr>
</table>
</td>
</tr>
</table>
</body>
</html>


<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>Climate Prediction Center - wgrib2: -fix_CFSv2_fcst</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1252">
  <meta content="NCEP Web Team" name="GENERATOR">
  <meta name="keywords"
  content="Climate,Climate Prediction Center,National Weather Service,National Oceanic &amp; Atmospheric Administration, NOAA,El Nino,La Nina,ENSO,climate outlooks,El Nino Advisory,La Nina Advisory,droughts,hurricanes,Threats Assessment,Drought Assessment,Drought Monitor,CLimate Diagnostics Bulletin,6-10 day outlook,8-14 day outlook, 6-10 day forecast,8-14 day forecast,MRF,UV Index,North Atlantic Oscillation,NAO,Pacific Decadal Oscillation,PDO,sea surface temperatures,SST,Palmer Drought Severity Index, African Desk,outlooks,expert assessments,monitoring,advisories,stratosphere,temperature,precipitation,snow cover,snowfall,soil moisture,OLR,ozone,degree days,CLIMATE,CLIMATE PREDICTION CENTER,EL NINO,LA NINA, CLIMATE OUTLOOKS,HURRICANES,ASSESSMENTS,SNOW,STRATOSPHERE,DROUGHT,OZONE,DEGREE DAYS">
  <link href="/nwscwi/main.css" type="text/css" rel="STYLESHEET">
</head>
<body leftmargin="0" background="/nwscwi/background.gif" 
      topmargin="0" rightmargin="0" marginheight="0" marginwidth="0">
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/topbanner.jpg" border="0">
  <tr>
    <td align="right" height="19">
      <a href="#contents"><img height="1" alt="Skip Navigation Links"
         src="/nwscwi/skipgraphic.gif" width="1" border="0"></a>
      <a href="https://www.nws.noaa.gov/" class="homepagelinks"><span class="nwslink">www.nws.noaa.gov</span></a>&nbsp;</td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
  <tr>
    <td rowspan="2"><a href="https://www.noaa.gov/">
      <img height="78" alt="NOAA logo - Click to go to the NOAA home page"
      src="/nwscwi/noaaleft.jpg" width="85" border="0"></a></td>
    <td align="left"><img height="20" alt="National Weather Service"
      src="/nwscwi/nws_title.jpg" width="500" border="0"></td>
    <td rowspan="2" width="100%" background="/nwscwi/ncep_bkgrnd.jpg">&nbsp;</td>
    <td rowspan="2" align="right"><a href="https://www.nws.noaa.gov/">
      <img height="78" alt="NWS logo - Click to go to the NWS home page"
      src="/nwscwi/nwsright.jpg" width="85" border="0"></a></td>
  </tr>
  <tr>
    <td><img height="58" alt="Climate Prediction Center" src="/nwscwi/cpc.jpg"
             width="500" border="0"></td>    <!-- Put your center header image here. -->
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/navbkgrnd.gif" border="0">
  <tr>
    <td align="left" valign="top" width="94"><img height="23" alt="" src="/nwscwi/navbarleft.jpg" width
="94" border="0"></td>
    <td class="nav" align="center" width="15%">
      <a href="/products/site_index.html" class="menu">Site Map</a></td> <!-- Build a text only sitemap, and link to it via this
                                                    sitemap button just below the banner.
                                                    The sitemap should include a heirarchy of links
                                                    from NOAA, to the NWS, to NCEP, and then through your site. -->
    <td class="nav" align="right" width="15%">
      <a href="https://www.nws.noaa.gov/pa/" class="menu">News</a></td>
    <td class="nav" id="menuitem" align="right" width="20%">
      <a href="https://weather.gov/organization.php" class="menu">Organization</a></td>
    <td class="yellow" align="right" width="20%">
      <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
        <label for="search">Search</label>&nbsp;</td>
    <td align="left" class="searchinput" width="20%" nowrap>
      <input type="hidden" name="parsed" value="true">
      <input type="hidden" name="rn" value="3">
      <input type="hidden" name="in0" value="domain">
      <input type="hidden" name="dom0" value="nws.noaa.gov, weather.gov, wrh.noaa.gov, srh.noaa.gov, crh.noaa.gov, prh.noaa.gov, arh.noaa.gov, alaska.net/~nwsar, erh.noaa.gov, ncep.noaa.gov, wwb.noaa.gov, spc.noaa.gov, nhc.noaa.gov, sec.noaa.gov, aviationweather.gov, aviationweather.noaa.gov, weather.noaa.gov, roc.noaa.gov, nohrsc.nws.gov, nwstc.noaa.gov, wdtb.noaa.gov, npmoc.navy.mil, ndbc.noaa.gov">
      <input type="text" name="mw0" value="All NWS Search" id="search" size="20" maxlength="256">
      <input type="submit" name="Go2" value="Go"></td>
    <td width="10%">&nbsp;</form></td>
    <td align="right" valign="bottom" width="24"><img height="23" alt="" src="/nwscwi/navbarendcap.jpg"
 width="24" border="0"></td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="670" border="0">
  <tr valign="top">
    <td width="137"><br>
      <table cellspacing="0" cellpadding="2" width="137" border="0">
        <!-- Do not remove this section. You will need this when the City,St/zip search is implemented nationwide.-->
        <!-- <tr align="left" valign="top">
                <td class="searchinput">
                  <div id="Layer2" style="position:absolute; width:200px; height:115px; z-index:2; visibility: hidden">Search by city or zip code. Press enter or select the go button to submit request</div>
                  <form method="POST" action="https://www.srh.noaa.gov/zipcity.php">
                  <span class="yellow">Local forecast by<br>&quot;City, St&quot; or Zip Code</span><br>
                  <input type="text" name="inputstring" size="9" value="City, St">
                  <input type="submit" name="Go2" value="Go"></form></td>
        </tr> -->
         <tr>
          <td class="searchinput" align="left">
            <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
             <label for="search"><span class="yellow">CPC Search</span></label>
              <input type="hidden" name="parsed" value="true">
              <input type="hidden" name="rn" value="3">
              <input type="hidden" name="in0" value="domain">
              <input type="hidden" name="dom0" value="www.cpc.ncep.noaa.gov">
              <input type="text" name="mw0" id="search"  size="10" maxLength="256" value="CPC search">&nbsp;
              <input type="submit" name="Go2" value="Go">
          </form></td>
         </tr>
        <tr>
          <td class="white">
            <span class="yellow">About Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/mission.html" class="menu">Our Mission</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/" class="menu">Who We Are</a><br><br>
            <span class="yellow">Contact Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/personnel/contacts.html" class="menu">CPC Information</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/comment-form.html" class="menu">CPC Web Team</a><br><br>           
          </td>
        </tr>
      </table>
    </td>
    <td valign="top" align="center" width="533"><a name="contents"></a>

<!-- Begin content area -->

<table border="0" cellPadding="2" cellSpacing="0" align="center" width="533">
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
   <font face="Verdana,arial,serif" size="1"><a href="/index.html" class="homepagelinks"><strong>HOME</strong></a> &gt; <a href="/products/monitoring_and_data" class="homepagelinks">Monitoring_and_Data</a> &gt; <a href="/products/monitoring_and_data/oadata.html" class="homepagelinks">Oceanic and Atmospheric Data</a> &gt; <a href="/products/wesley/" class="homepagelinks">Reanalysis: Atmospheric Data</a> &gt; wgrib2-fix_CFSv2_fcst</font>
  </td>
 </tr>
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
<font color=red>
<h3 align=center>wgrib2: -fix_CFSv2_fcst</h3>
</font>


<h3><font color=red>Introduction</font></h3>

<p>
The Climate Forecast System version 2 (CFSv2) is a coupled atmosphere/ocean
forecast system that was developed at NCEP.  CFSv2 produces analyses (CFSR) 
and daily to seasonal forecats.  The seasonal forecasts consists of hindcasts
(CFSRR) and the real-time forecasts (CFSv2 forecasts).

<p>  The monthly-mean forecasts from the CFSRR and CFSv2 are originally
written in grib1 format and later converted to grib2 format for public
distribution.  In this process, the resulting grib2 files are mangled
and the metadata no longer correctly describes the contents of the file.
The <font color=red>-fix_CFSv2_fcst</font> option alters the metadata of the
CFSRR/CFSv2 monthly forecasts files to make them grib2 compliant and to
fix the metadata.  After the data has been fixed, the files can
then be read with grib2 decoders such as GrADS.


<h3><font color=red>CFSRR/CFSv2 Monthly Forecast File Names</font></h3>

The CFSv2 monthly forecasts have a naming convengtiion.

<pre>
<font color=blue>(NAME)(DATE0).(EN).(DATE1).avrg[.(HH)Z].grb2</font>

<font color=blue>NAME</font>=type of file
     flxf       forecast (f) data on special levels (flx)
     ipvf       forecast (f) data on isentropic surfaces (ipv)
     ocnf       forecast (f) data for the oceans (ocn)
     pgbf       forecast (f) data for pressure (p) levels grib (gb)

<font color=blue>DATE0</font>=starting time of the forecasts
      YYYYMMDDHH

<font color=blue>EN</font>=ensemble member number

<font color=blue>DATE1</font>=target month of the forecast
      YYYYMM

<font color=blue>[..]</font> = contents in the square brackets are optional

Case 1: contents of [] are missing or null
        The forecast system produces daily forecasts ending at 00Z, 06Z, 12Z and 18Z.
        All these forecasts are included in the forecast of the monthly mean.

Case 2: contents of [] are present, i.e., .(HH)Z
       HH = 00, 06, 12, 18
       The monthly forecast is for a specific cycle of the day.
       For example the 00Z cycle.  For instantaneous quantities,
       the monthly forecast will be consist of the mean of all daily forecasts 
       that verify on the 00Z hour.  For quantities that are 6 hour
       averages or accumulations, they will be the average of all the
       forecasts with averages/accumulations that end at 00Z hour
       (18Z-24Z average/accumulations).

       Unfortunately the original file doesn't contain any metadata
       concerning the hour or the type of quantity, so the hour
       has to be entered as an argument and the forecasts are
       assumed to be the average of instantaneous fields.
</pre>


<h3><font color=red>Fixing the CFSRR/CFSv2 monthly forecasts format</font></h3>

A filter was added to wgrib2 that fixes the metadata in
the CFSv2 monthly forecasts.  To fix the metadata, 

<pre>
<font color=brown>wgrib2 IN -fix_CFSv2_fcst TIME EN N_ENS -grib OUT</font>

IN=name of input grib file, ex. flxf2009010100.01.200901.avrg.06Z.grb2

TIME=daily, 00, 06, 12, 18
    use daily if .(HH)Z is missing from the input filename
    use 00 if .00Z is part of the input filename
    use 06 if .06Z is part of the input filename
    use 12 if .12Z is part of the input filename
    use 18 if .18Z is part of the input filename

EN=ensemble member number, suggested that EN from the filename is used but value is arbitrary.

N_ENS=number of ensemble members, use max of (EN).  Value is arbitrary.

OUT=name of the output grib file
</pre>

<h3><font color=red>Example of Fixing the CFSRR monthly forecast</font></h3>

<pre>
bash-3.2$ <font color=brown>wgrib2 flxf2009010100.01.200903.avrg.06Z.grb2 -for 1:3 -fix_CFSv2_fcst 06 1 1  -grib out.grb</font>
1:0:d=2009010100:UFLX:surface:1422 hour-(1422 hour+30 day) ave@(fcst,dt=1 day),missing=0:ENS=+1
2:66720:d=2009010100:VFLX:surface:1422 hour-(1422 hour+30 day) ave@(fcst,dt=1 day),missing=0:ENS=+1
3:133122:d=2009010100:SHTFL:surface:1422 hour-(1422 hour+30 day) ave@(fcst,dt=1 day),missing=0:ENS=+1

flxf2009010100.01.200903.avrg.06Z.grb2   input file
-for 1:3                                 process records 1..3
-fix_CFSv2_fcst 06 1 1                   fix metadata for 06Z type file, 
-grib out.grb                            save corrected file in out.grb
</pre>

<h3><font color=red>Examining our corrected file</font></h3>

The default wgrib2 inventory looks like

<pre>
bash-3.2$ <font color=brown>wgrib2 out.grb </font>
1:0:d=2009010100:UFLX:surface:1422 hour-(1422 hour+30 day) ave@(23 hour fcst)++,missing=0:ENS=+1
2:66719:d=2009010100:VFLX:surface:1422 hour-(1422 hour+30 day) ave@(23 hour fcst)++,missing=0:ENS=+1
3:133120:d=2009010100:SHTFL:surface:1422 hour-(1422 hour+30 day) ave@(23 hour fcst)++,missing=0:ENS=+1

d=2009010100                             initial time of the forecast
UFLX                                     zonal wind stress
1422 hour-(1422 hour+30 day) ave         average for 1422 hour to (1422 hours + 30 day)
(fcst,dt=1 day)                          average the forecast at 1 day intervales
missing=0                                no missing fields in the average
</pre>

Now I can't figure out 1422 hours in my head, so I can print out the start and and of the
forecast time interval by,

<pre>
bash-3.2$ <font color=brown>wgrib2 out.grb -start_ft -end_ft</font>
1:0:start_ft=2009030106:end_ft=2009033106
2:66719:start_ft=2009030106:end_ft=2009033106
3:133120:start_ft=2009030106:end_ft=2009033106
</pre>

Notice the start_ft has a 06 hour as you would have expected from the original file,
flxf2009010100.01.200903.avrg.06Z.grb2.  

<h3><font color=red>Adding Ocean Metadata</font></h3>

<p> In the NCDC archives, the DBSS variable has bad level information.
For example, the time series of N degree isotherm is not encoded correctly

<pre>
bash-3.2$ wgrib2 dt5c.ensm.apr.cfsv2.data.grb2
1:0:d=1982040618:DBSS:0C ocean isotherm:0-1 month ave fcst:
2:42547:d=1982040618:DBSS:0C ocean isotherm:1-2 month ave fcst:
3:85611:d=1982040618:DBSS:0C ocean isotherm:2-3 month ave fcst:
4:128757:d=1982040618:DBSS:0C ocean isotherm:3-4 month ave fcst:
...

The level should be 5C ocean isotherm as indicated by the file name.
<pre>

To fix this time series, you need to rewrite the level information.

<pre>
bash-3.2$ <font color=brown>wgrib2 dt5c.ensm.apr.cfsv2.data.grb2 -set_lev "5C ocean isotherm" -grib dt5c.ensm.apr.cfsv2.data.grb2.new</font>
1:0:d=1982040618:DBSS:5C ocean isotherm:0-1 month ave fcst:
2:42547:d=1982040618:DBSS:5C ocean isotherm:1-2 month ave fcst:
3:85611:d=1982040618:DBSS:5C ocean isotherm:2-3 month ave fcst:
4:128757:d=1982040618:DBSS:5C ocean isotherm:3-4 month ave fcst:
...
</pre>

In monthly ocean forecasts @ NCDC, we can find bad level data.  For example,
one file had bad level metadata for messages 216-222.
<pre>
216:11232042:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst:
217:11278152:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst:
218:11322088:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst:
219:11360222:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst:
220:11392818:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst:
221:11419935:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst:
222:11440970:d=1999052200:DBSS:0C ocean isotherm:2-3 month ave fcst: 
</pre>

The following code snippet will fix the level data for the above file.
<pre>
wgrib2 $f \
 -if "^216:" -set_lev "2.5C ocean isotherm"  -fi \
 -if "^217:" -set_lev "5C ocean isotherm"  -fi \
 -if "^218:" -set_lev "10C ocean isotherm"  -fi \
 -if "^219:" -set_lev "15C ocean isotherm"  -fi \
 -if "^220:" -set_lev "20C ocean isotherm"  -fi \
 -if "^221:" -set_lev "25C ocean isotherm"  -fi \
 -if "^222:" -set_lev "28C ocean isotherm"  -fi  \
 -grib $f.fixed
</pre>



<h3><font color=red>Making GrADS control files</font></h3>

Once you have converted the files using the <font color=red>-fix_CFSv2_fcst</font> option,
you have to use the -b option in g2ctl/gribmap to get the target times to line up correctly.  
The -b option sets the start of the target month as the GrADS time.  If you use the default option,
you will get the end of the forecast period.  For the ordinary forecast files, that will be
at 18Z of the last month.  Definately not as friendly.

<pre>
bash-3.2$ <font color=brown>g2ctl -b out.grb >out.ctl</font>
bash-3.2$ <font color=brown>gribmap -b -i out.ctl</font>
grib2map: scanning GRIB2 file: out.grb
grib2map: Writing out the index file 
</pre>


<h3><font color=red>A Real Example</font></h3>

<p>
The previous examples were the conversion, inventory and display of a single file.
Most of the time, people would want to examine the entire forecast run.  In this
followring example, we look at a forecast run.  Here we cannot include
the file with the target month which is the same as the starting month
because this file does not start on the 1st of the month like the other files.

<pre>
CFSRR files:

    (do not include this file) -->   pgbf2009081500.01.200908.avrg.grb2
    pgbf2009081500.01.200909.avrg.grb2
    pgbf2009081500.01.200910.avrg.grb2
    pgbf2009081500.01.200911.avrg.grb2
</pre>

Fixing the metadata in the bash shell on a linux box.

<pre>
bash-3.2$ <font color=brown>for f in pgbf2009081500.01.2009??.avrg.grb2</font>
><font color=brown>do</font>
><font color=brown> wgrib2 $f -fix_CFSv2_fcst_daily 1 1 -grib $f.new >/dev/null</font>
><font color=brown>done</font>
fix_CFSRv2_fcst 524 fields fixed
fix_CFSRv2_fcst 524 fields fixed
fix_CFSRv2_fcst 524 fields fixed
</pre>

Making the GrADS ctl and idx files.  Note the -b options to both g2ctl and gribmap.
Note that gribmap v2 and grads v2 have to be used.  Note the use of the template (%m2) in
the g2ctl line.


<pre>
bash-3.2$<font color=brown> g2ctl -b pgbf2009081500.01.2009%m2.avrg.grb2.new >pgb.ctl</font>
bash-3.2$<font color=brown> gribmap -b -i pgb.ctl</font>
grib2map: scanning GRIB2 file: pgbf2009081500.01.200909.avrg.grb2.new 
grib2map: scanning GRIB2 file: pgbf2009081500.01.200910.avrg.grb2.new 
grib2map: scanning GRIB2 file: pgbf2009081500.01.200911.avrg.grb2.new 
grib2map: reached end of files
grib2map: Writing out the index file 
</pre>

Running grads v2 with the new ctl/idx file.

<pre>
bash-3.2$<font color=brown> grads</font>

Grid Analysis and Display System (GrADS) Version 2.0.a9
Copyright (c) 1988-2010 by Brian Doty and the
Institute for Global Environment and Society (IGES)
GrADS comes with ABSOLUTELY NO WARRANTY
See file COPYRIGHT for more information

Config: v2.0.a9 little-endian readline printim grib2 netcdf hdf4-sds hdf5 opendap-grids,stn geotiff shapefile
Issue 'q config' command for more detailed configuration information
Landscape mode? ('n' for portrait):
GX Package Initialization: Size = 11 8.5 
ga-><font color=brown> open pgb.ctl</font>
Scanning description file:  pgb.ctl
Data file pgbf2009081500.01.2009%m2.avrg.grb2.new is open as file 1
LON set to 0 360 
LAT set to -90 90 
LEV set to 1000 1000 
Time values set: 2009:8:15:0 2009:8:15:0 
E set to 1 1 
ga-><font color=brown> set lev 500</font>
LEV set to 500 500 
ga-><font color=brown> d hgtprs</font>
Contouring: 4900 to 5900 interval 100 
ga-> 
</pre>

<h3><font color=red>Encoding the Ensemble Information</font></h3>
<p>
The <font color=red>-fix_CFSv2_fcst</font> option adds enesemble information.  The directions
suggest that you number the runs using the same numbers as suggested by the CFSv2 filename convention.
That will minimize confusion.  However, you are allowed to give any ensemble number
up to 254. Usiog unique ensemble member numbers would be useful GrADS.
</p>

<h3><font color=red>Caveats</font></h3>
<p>
The filtering action of <font color=red>-fix_CFSv2_fcst</font> assumes that the fields
that were averaged were instantaneous fields (ex. Z500 at a specific time).  This
is not true as some fields are 6-hour accumulations or averages.  Grib2 can describe
averages of accumulations/averages.  However, this nuance was ignored.

<p>
The instructions suggest that you encode the CFSRR enemble member number as 1 to be consistent
with the CFSv2 file name convention.  For CFSRR, there is only one ensemble member (01) which
by would be considered the high-resolution control run.  

<h3><font color=red>Usage</font></h3>
<p>

<pre>
-fix_CFSv2_fcst X Y Z
X=daily, 00, 06, 12, 18
Y=Ensemble member number (perturbation number)
Z=number of ensemble members
</pre>




</td>
</tr>


<!--  End of Content area  -->
<!--   ...............................................Footer Portion.........................................    -->
 <tr>
  <td>
   <table width="500">
    <tr>
     <td colSpan="3"><hr></td>
    </tr>
    <TR vAlign="top">
     <TD class="gray">
      <A href="https://www.noaa.gov/" class="homepagelinks"><SPAN class="gray">NOAA/</SPAN></A>
      <A href="https://www.nws.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Weather Service</SPAN></A><BR>
      <A href="https://www.ncep.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Centers for Environmental Prediction</SPAN></a><BR>
        Climate Prediction Center<BR>
        5830 University Research Court<BR>
        College Park, Maryland 20740<BR>
      <A href="/comment-form.html" class="homepagelinks"><SPAN class="gray">Climate Prediction Center Web Team</SPAN></A><BR>
        Page last modified: Nov 2, 2011
     </TD>
     <TD>
      <A href="https://weather.gov/disclaimer.php" class="homepagelinks"><SPAN class="gray">Disclaimer</SPAN></A>
     </TD>
     <TD align="right">
      <A href="https://weather.gov/privacy.php" class="homepagelinks"> <SPAN class="gray">Privacy Policy</SPAN></A>
     </TD>
    </TR>
   </table>
  </td>
 </tr>
</table>
</td>
</tr>
</table>
</body>
</html>


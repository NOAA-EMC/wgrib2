<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>Climate Prediction Center - wgrib2api: grb2_wrt</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1252">
  <meta content="NCEP Web Team" name="GENERATOR">
  <meta name="keywords"
  content="Climate,Climate Prediction Center,National Weather Service,National Oceanic &amp; Atmospheric Administration, NOAA,El Nino,La Nina,ENSO,climate outlooks,El Nino Advisory,La Nina Advisory,droughts,hurricanes,Threats Assessment,Drought Assessment,Drought Monitor,CLimate Diagnostics Bulletin,6-10 day outlook,8-14 day outlook, 6-10 day forecast,8-14 day forecast,MRF,UV Index,North Atlantic Oscillation,NAO,Pacific Decadal Oscillation,PDO,sea surface temperatures,SST,Palmer Drought Severity Index, African Desk,outlooks,expert assessments,monitoring,advisories,stratosphere,temperature,precipitation,snow cover,snowfall,soil moisture,OLR,ozone,degree days,CLIMATE,CLIMATE PREDICTION CENTER,EL NINO,LA NINA, CLIMATE OUTLOOKS,HURRICANES,ASSESSMENTS,SNOW,STRATOSPHERE,DROUGHT,OZONE,DEGREE DAYS">
  <link href="/nwscwi/main.css" type="text/css" rel="STYLESHEET">
</head>
<body leftmargin="0" background="/nwscwi/background.gif" 
      topmargin="0" rightmargin="0" marginheight="0" marginwidth="0">
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/topbanner.jpg" border="0">
  <tr>
    <td align="right" height="19">
      <a href="#contents"><img height="1" alt="Skip Navigation Links"
         src="/nwscwi/skipgraphic.gif" width="1" border="0"></a>
      <a href="https://www.nws.noaa.gov/" class="homepagelinks"><span class="nwslink">www.nws.noaa.gov</span></a>&nbsp;</td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
  <tr>
    <td rowspan="2"><a href="https://www.noaa.gov/">
      <img height="78" alt="NOAA logo - Click to go to the NOAA home page"
      src="/nwscwi/noaaleft.jpg" width="85" border="0"></a></td>
    <td align="left"><img height="20" alt="National Weather Service"
      src="/nwscwi/nws_title.jpg" width="500" border="0"></td>
    <td rowspan="2" width="100%" background="/nwscwi/ncep_bkgrnd.jpg">&nbsp;</td>
    <td rowspan="2" align="right"><a href="https://www.nws.noaa.gov/">
      <img height="78" alt="NWS logo - Click to go to the NWS home page"
      src="/nwscwi/nwsright.jpg" width="85" border="0"></a></td>
  </tr>
  <tr>
    <td><img height="58" alt="Climate Prediction Center" src="/nwscwi/cpc.jpg"
             width="500" border="0"></td>    <!-- Put your center header image here. -->
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/navbkgrnd.gif" border="0">
  <tr>
    <td align="left" valign="top" width="94"><img height="23" alt="" src="/nwscwi/navbarleft.jpg" width
="94" border="0"></td>
    <td class="nav" align="center" width="15%">
      <a href="/products/site_index.html" class="menu">Site Map</a></td> <!-- Build a text only sitemap, and link to it via this
                                                    sitemap button just below the banner.
                                                    The sitemap should include a heirarchy of links
                                                    from NOAA, to the NWS, to NCEP, and then through your site. -->
    <td class="nav" align="right" width="15%">
      <a href="https://www.nws.noaa.gov/pa/" class="menu">News</a></td>
    <td class="nav" id="menuitem" align="right" width="20%">
      <a href="https://weather.gov/organization.php" class="menu">Organization</a></td>
    <td class="yellow" align="right" width="20%">
      <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
        <label for="search">Search</label>&nbsp;</td>
    <td align="left" class="searchinput" width="20%" nowrap>
      <input type="hidden" name="parsed" value="true">
      <input type="hidden" name="rn" value="3">
      <input type="hidden" name="in0" value="domain">
      <input type="hidden" name="dom0" value="nws.noaa.gov, weather.gov, wrh.noaa.gov, srh.noaa.gov, crh.noaa.gov, prh.noaa.gov, arh.noaa.gov, alaska.net/~nwsar, erh.noaa.gov, ncep.noaa.gov, wwb.noaa.gov, spc.noaa.gov, nhc.noaa.gov, sec.noaa.gov, aviationweather.gov, aviationweather.noaa.gov, weather.noaa.gov, roc.noaa.gov, nohrsc.nws.gov, nwstc.noaa.gov, wdtb.noaa.gov, npmoc.navy.mil, ndbc.noaa.gov">
      <input type="text" name="mw0" value="All NWS Search" id="search" size="20" maxlength="256">
      <input type="submit" name="Go2" value="Go"></td>
    <td width="10%">&nbsp;</form></td>
    <td align="right" valign="bottom" width="24"><img height="23" alt="" src="/nwscwi/navbarendcap.jpg"
 width="24" border="0"></td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="670" border="0">
  <tr valign="top">
    <td width="137"><br>
      <table cellspacing="0" cellpadding="2" width="137" border="0">
        <!-- Do not remove this section. You will need this when the City,St/zip search is implemented nationwide.-->
        <!-- <tr align="left" valign="top">
                <td class="searchinput">
                  <div id="Layer2" style="position:absolute; width:200px; height:115px; z-index:2; visibility: hidden">Search by city or zip code. Press enter or select the go button to submit request</div>
                  <form method="POST" action="https://www.srh.noaa.gov/zipcity.php">
                  <span class="yellow">Local forecast by<br>&quot;City, St&quot; or Zip Code</span><br>
                  <input type="text" name="inputstring" size="9" value="City, St">
                  <input type="submit" name="Go2" value="Go"></form></td>
        </tr> -->
         <tr>
          <td class="searchinput" align="left">
            <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
             <label for="search"><span class="yellow">CPC Search</span></label>
              <input type="hidden" name="parsed" value="true">
              <input type="hidden" name="rn" value="3">
              <input type="hidden" name="in0" value="domain">
              <input type="hidden" name="dom0" value="www.cpc.ncep.noaa.gov">
              <input type="text" name="mw0" id="search"  size="10" maxLength="256" value="CPC search">&nbsp;
              <input type="submit" name="Go2" value="Go">
          </form></td>
         </tr>
        <tr>
          <td class="white">
            <span class="yellow">About Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/mission.html" class="menu">Our Mission</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/" class="menu">Who We Are</a><br><br>
            <span class="yellow">Contact Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/personnel/contacts.html" class="menu">CPC Information</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/comment-form.html" class="menu">CPC Web Team</a><br><br>           
          </td>
        </tr>
      </table>
    </td>
    <td valign="top" align="center" width="533"><a name="contents"></a>

<!-- Begin content area -->

<table border="0" cellPadding="2" cellSpacing="0" align="center" width="533">
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
   <font face="Verdana,arial,serif" size="1"><a href="/index.html" class="homepagelinks"><strong>HOME</strong></a> &gt; <a href="/products/monitoring_and_data" class="homepagelinks">Monitoring_and_Data</a> &gt; <a href="/products/monitoring_and_data/oadata.html" class="homepagelinks">Oceanic and Atmospheric Data</a> &gt; <a href="/products/wesley/" class="homepagelinks">Reanalysis: Atmospheric Data</a> &gt; wgrib2api: grb2_wrt</font>
  </td>
 </tr>
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
<font color=red>
<h3 align=center>wgrib2api: grb2_wrt(..)</h3>
</font>


<h3>Introduction</h3>

<p>
Writing grib using wgrib2api is simple. You need 
<ol>
<li> gridded data you want to write
<li> sample grib2 message with the same grid as (1) and unchanging
     metadata such as center/subcenter/process-id
<li> the changing metadata in a wgrib2-style string such as<br>
     'd=1999123100:HGT:500 mb:anl:', 'D=20170102123000:UGRD:2 m above ground:15 minute fcst:'
</ol>

<p>
The grb2_wrt(..) function will
take the template, change the grid values, change the grib headers based
on the metadata string and write out the grib message.
<p>
<font color="red">
<p>
Optional parameters that are in the grb2_wrt source code that
are not documented here are to be considered to be alpha
code. 
</font>
<h3>A simple fortran program to write grib2</h3>
<pre>
use wgrib2api
real, allocatable :: grid(:,:)

allocate (grid(360:181))
read(11) grid
i = grb2_wrt('out.grb2','tempplate.grb2',1,data2=grid,meta='D=20170102030000:HGT:500 mb:anl:')
write(*,*) 'error=',i
stop
end
</pre>

<h3>A simple program to write out the 10 m wind speed</h3>
<pre>
use wgrib2api
real, allocatable :: u(:,:), v(:,:)
character (len=200) meta

i=grb2_mk_inv('gep19.t00z.pgrb2af180','in.inv')                    <font color=red>! make index file</font>
if (i.ne.0) stop 1
i=grb2_inq('gep19.t00z.pgrb2af180','in.inv', ':UGRD:10 m above ground:', data2=u) <font color=red>! read U</font>
if (i.ne.1) stop 2                                                 <font color=red>! only want one match</font>
i=grb2_inq('gep19.t00z.pgrb2af180','in.inv', ':VGRD:10 m above ground:', data2=v,& <font color=red>! read V</font>
     desc=meta)
if (i.ne.1) stop 3                                                 <font color=red>! only want one match</font>

u=sqrt(u*u+v*v)                                                    <font color=red>! calculate wind speed</font>
i=grb2_wrt('out.grb','gep19.t00z.pgrb2af180',1,data2=u,meta=meta,var='WIND')  <font color=red>! write wind speed</font>
<font color=red>! using grib message 1 of original file as a template
!  modifying the variable to WIND (wind speed</font>
if (i.ne.0) stop 4
write(*,*) ' file : out.grb'
stop
end
</pre>

<h3>Code fragment to write surface hgt from ss2grb2.f90</h3>

<pre>
  metadata='d=' // datecode // ':HGT:surface:' // trim(ftime) // ':'
  iret = grb2_wrt(grib_output,grib_template,1,hgt_sfc,meta=metadata,order='raw')
  if (iret.ne.0) stop 1
  write(*,*) 'grib_write HGTsfc'
</pre>
<p> The grib template, grib_template, is created on the fly by using wgrib2
to alter the grid.

<p> In ss2grb2, the grids are stored in we:ns order and we want the output grids
to be in we:ns order.  So the order parameter is set to raw.  The order could
have been set to we:ns but raw is slightly faster.

<h3>Code fragment to write hgt(pres) from ss2grb2.f90</h3>
<pre>
  do i = 1, n_plevs
     metadata='d=' // datecode // ':HGT:' // trim(plevs_txt(i)) &
       // ':' // trim(ftime) // ':'
     iret = grb2_wrt(grib_output,grib_template,1,xz(:,i),meta=metadata,order='raw')
     if (iret.ne.0) stop 4
  enddo
  write(*,*) 'grib_write HGT mb'
</pre>
<p> The pressure levels are defined by both a numeric value (plevs(n_plevs) 
and a text string (plevs_txt(n_plevs)).  Note that the loop that writes
calls grb2_wrt(..) is not multithreaded (no !$OMP PARALLEL DO) because
the wgrib2api is not thread safe.

<p> You may notice that both code fragments use the old style where you modify
the metadata.  The new style wasn't available for ss2grb2.f90.


<h3> Usage</h3>
<pre>
    iret =     grb2_wrt(GRB2, TEMPLATE, IMSG, data2=GRID, meta=META, (list of optional arguments))
               or
    iret =     grb2_wrt(GRB2, TEMPLATE, IMSG, data1=GRID1, meta=META, (list of optional arguments))

    iret:      integer
               0 grib message written
               1 grib message not written

               Necessary Parameters

    GRB2:      character (len=*) output grib file
    TEMPLATE:  character (len=*) template file
    IMSG:      integer, grib message number to be used as template
    data2:     real allocatable :: grid(nx:ny)          : modern programs
               values of grid
    data1:     real grid1(nx*ny)                        : legacy programs
               values of grid
    meta:      character (len=*) metadata string, modeled on wgrib2 -S

               Optional Parameters

    meta:      is optional, concise form of the metadata
    append:    integer
               0     create GRB2
               /= 0  append to GRB2
    encode_bits: N, integer
               use ECMWF-style scaling (wgrib2 default)
               grid values = I * 2**M + offset, where I = 0..2^N - 1
               I has at most N bits
               wgrib2/wgrib2api supports N as large as 25.
    debug:     integer
               0     no debug information
               /= 0  debug information
    order:     character (len=*)
               'we:sn'             grid data is we:sn order  (DEFAULT)
               'we:ns'             grid data is we:ns order
               'raw'               grid data is raw order

               Parameters that Override Values in Metadata String (v2.0.7)

    var:       character (len=*)
               ex. 'HGT', 'TMP'
    date:      integer (kind=8)
               sets the reference date, format is YYYYMMDDHHmmss
    level:     character (len=*)
               wgrib2 style level definition, ex. '10 m above ground', '50 mb'
    timing:    character (len=*)
               wgrib2 style forecast type, ex. 12 hour fcst, 0-6 hour ave fcst

    center:    integer, 0..255
               WMO defined center id, 255=undefined
    subcenter: integer, 0..255
               subcenter id, 255=undefined
    packing:   character (len=*)
               wgrib2 style packing name, ex c1, aec, simple
</pre>

</td>
</tr>


<!--  End of Content area  -->
<!--   ...............................................Footer Portion.........................................    -->
 <tr>
  <td>
   <table width="500">
    <tr>
     <td colSpan="3"><hr></td>
    </tr>
    <TR vAlign="top">
     <TD class="gray">
      <A href="https://www.noaa.gov/" class="homepagelinks"><SPAN class="gray">NOAA/</SPAN></A>
      <A href="https://www.nws.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Weather Service</SPAN></A><BR>
      <A href="https://www.ncep.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Centers for Environmental Prediction</SPAN></a><BR>
        Climate Prediction Center<BR>
        5830 University Research Court<BR>
        College Park, Maryland 20740<BR>
      <A href="/comment-form.html" class="homepagelinks"><SPAN class="gray">Climate Prediction Center Web Team</SPAN></A><BR>
        Page last modified: April 7, 2017
     </TD>
     <TD>
      <A href="https://weather.gov/disclaimer.php" class="homepagelinks"><SPAN class="gray">Disclaimer</SPAN></A>
     </TD>
     <TD align="right">
      <A href="https://weather.gov/privacy.php" class="homepagelinks"> <SPAN class="gray">Privacy Policy</SPAN></A>
     </TD>
    </TR>
   </table>
  </td>
 </tr>
</table>
</td>
</tr>
</table>
</body>
</html>


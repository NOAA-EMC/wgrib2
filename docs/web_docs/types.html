<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>Climate Prediction Center - wgrib2: options</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1252">
  <meta content="NCEP Web Team" name="GENERATOR">
  <meta name="keywords"
  content="Climate,Climate Prediction Center,National Weather Service,National Oceanic &amp; Atmospheric Administration, NOAA,El Nino,La Nina,ENSO,climate outlooks,El Nino Advisory,La Nina Advisory,droughts,hurricanes,Threats Assessment,Drought Assessment,Drought Monitor,CLimate Diagnostics Bulletin,6-10 day outlook,8-14 day outlook, 6-10 day forecast,8-14 day forecast,MRF,UV Index,North Atlantic Oscillation,NAO,Pacific Decadal Oscillation,PDO,sea surface temperatures,SST,Palmer Drought Severity Index, African Desk,outlooks,expert assessments,monitoring,advisories,stratosphere,temperature,precipitation,snow cover,snowfall,soil moisture,OLR,ozone,degree days,CLIMATE,CLIMATE PREDICTION CENTER,EL NINO,LA NINA, CLIMATE OUTLOOKS,HURRICANES,ASSESSMENTS,SNOW,STRATOSPHERE,DROUGHT,OZONE,DEGREE DAYS">
  <link href="/nwscwi/main.css" type="text/css" rel="STYLESHEET">
</head>
<body leftmargin="0" background="/nwscwi/background.gif" 
      topmargin="0" rightmargin="0" marginheight="0" marginwidth="0">
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/topbanner.jpg" border="0">
  <tr>
    <td align="right" height="19">
      <a href="#contents"><img height="1" alt="Skip Navigation Links"
         src="/nwscwi/skipgraphic.gif" width="1" border="0"></a>
      <a href="https://www.nws.noaa.gov/" class="homepagelinks"><span class="nwslink">www.nws.noaa.gov</span></a>&nbsp;</td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
  <tr>
    <td rowspan="2"><a href="https://www.noaa.gov/">
      <img height="78" alt="NOAA logo - Click to go to the NOAA home page"
      src="/nwscwi/noaaleft.jpg" width="85" border="0"></a></td>
    <td align="left"><img height="20" alt="National Weather Service"
      src="/nwscwi/nws_title.jpg" width="500" border="0"></td>
    <td rowspan="2" width="100%" background="/nwscwi/ncep_bkgrnd.jpg">&nbsp;</td>
    <td rowspan="2" align="right"><a href="https://www.nws.noaa.gov/">
      <img height="78" alt="NWS logo - Click to go to the NWS home page"
      src="/nwscwi/nwsright.jpg" width="85" border="0"></a></td>
  </tr>
  <tr>
    <td><img height="58" alt="Climate Prediction Center" src="/nwscwi/cpc.jpg"
             width="500" border="0"></td>    <!-- Put your center header image here. -->
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/navbkgrnd.gif" border="0">
  <tr>
    <td align="left" valign="top" width="94"><img height="23" alt="" src="/nwscwi/navbarleft.jpg" width
="94" border="0"></td>
    <td class="nav" align="center" width="15%">
      <a href="/products/site_index.html" class="menu">Site Map</a></td> <!-- Build a text only sitemap, and link to it via this
                                                    sitemap button just below the banner.
                                                    The sitemap should include a heirarchy of links
                                                    from NOAA, to the NWS, to NCEP, and then through your site. -->
    <td class="nav" align="right" width="15%">
      <a href="https://www.nws.noaa.gov/pa/" class="menu">News</a></td>
    <td class="nav" id="menuitem" align="right" width="20%">
      <a href="https://weather.gov/organization.php" class="menu">Organization</a></td>
    <td class="yellow" align="right" width="20%">
      <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
        <label for="search">Search</label>&nbsp;</td>
    <td align="left" class="searchinput" width="20%" nowrap>
      <input type="hidden" name="parsed" value="true">
      <input type="hidden" name="rn" value="3">
      <input type="hidden" name="in0" value="domain">
      <input type="hidden" name="dom0" value="nws.noaa.gov, weather.gov, wrh.noaa.gov, srh.noaa.gov, crh.noaa.gov, prh.noaa.gov, arh.noaa.gov, alaska.net/~nwsar, erh.noaa.gov, ncep.noaa.gov, wwb.noaa.gov, spc.noaa.gov, nhc.noaa.gov, sec.noaa.gov, aviationweather.gov, aviationweather.noaa.gov, weather.noaa.gov, roc.noaa.gov, nohrsc.nws.gov, nwstc.noaa.gov, wdtb.noaa.gov, npmoc.navy.mil, ndbc.noaa.gov">
      <input type="text" name="mw0" value="All NWS Search" id="search" size="20" maxlength="256">
      <input type="submit" name="Go2" value="Go"></td>
    <td width="10%">&nbsp;</form></td>
    <td align="right" valign="bottom" width="24"><img height="23" alt="" src="/nwscwi/navbarendcap.jpg"
 width="24" border="0"></td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="670" border="0">
  <tr valign="top">
    <td width="137"><br>
      <table cellspacing="0" cellpadding="2" width="137" border="0">
        <!-- Do not remove this section. You will need this when the City,St/zip search is implemented nationwide.-->
        <!-- <tr align="left" valign="top">
                <td class="searchinput">
                  <div id="Layer2" style="position:absolute; width:200px; height:115px; z-index:2; visibility: hidden">Search by city or zip code. Press enter or select the go button to submit request</div>
                  <form method="POST" action="https://www.srh.noaa.gov/zipcity.php">
                  <span class="yellow">Local forecast by<br>&quot;City, St&quot; or Zip Code</span><br>
                  <input type="text" name="inputstring" size="9" value="City, St">
                  <input type="submit" name="Go2" value="Go"></form></td>
        </tr> -->
         <tr>
          <td class="searchinput" align="left">
            <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
             <label for="search"><span class="yellow">CPC Search</span></label>
              <input type="hidden" name="parsed" value="true">
              <input type="hidden" name="rn" value="3">
              <input type="hidden" name="in0" value="domain">
              <input type="hidden" name="dom0" value="www.cpc.ncep.noaa.gov">
              <input type="text" name="mw0" id="search"  size="10" maxLength="256" value="CPC search">&nbsp;
              <input type="submit" name="Go2" value="Go">
          </form></td>
         </tr>
        <tr>
          <td class="white">
            <span class="yellow">About Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/mission.html" class="menu">Our Mission</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/" class="menu">Who We Are</a><br><br>
            <span class="yellow">Contact Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/personnel/contacts.html" class="menu">CPC Information</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/comment-form.html" class="menu">CPC Web Team</a><br><br>           
          </td>
        </tr>
      </table>
    </td>
    <td valign="top" align="center" width="533"><a name="contents"></a>

<!-- Begin content area -->

<table border="0" cellPadding="2" cellSpacing="0" align="center" width="533">
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
   <font face="Verdana,arial,serif" size="1"><a href="/index.html" class="homepagelinks"><strong>HOME</strong></a> &gt; <a href="/products/monitoring_and_data" class="homepagelinks">Monitoring_and_Data</a> &gt; <a href="/products/monitoring_and_data/oadata.html" class="homepagelinks">Oceanic and Atmospheric Data</a> &gt; <a href="/products/wesley/" class="homepagelinks">Reanalysis: Atmospheric Data</a> &gt; wgrib2 options</font>
  </td>
 </tr>
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
<font color=red>
<h3 align=center>Options</h3>
</font>


<h3>Introduction</h3>

<p>
The wgrib2 command line consists of a list of options and a grib file 
to be processed.  The options like
<font color=red>-if</font>,
<font color=red>-else</font>, and
<font color=red>-endif</font> can alter the 'run_flag' which is the basis
of the IF-ELSE-ENDIF blocks.

<h3>Types of Options</h3>


<pre>
wgrib2:      *.c:
------       ---
if           If                For IF/ELSE/ELSEIF/ENDIF type options
else         Else
elseif       Elseif
endif        Endif

init         setup             only called in the beginning, for set up

inv          inv               print output to stdout (make an inventory)
inv>         inv_output        print to a file (make an inventory)
out          output            write to a file with a non-inventory output, ex binary
misc         misc              any thing else
</pre>


<h3>How "Options" are called</h3>
<h3>What is "mode"</h3>

<p>
Each option is associated with a subroutine.  Each option is "called"
for setup (mode == -1).  This allows
the option to do initialization such as setting up the flags,
checking the arguments and opening files.  This is the only
time that init or setup options are called.
The <font color=red>-match</font> and <font color=red>-d</font> options are init options because
it sets up the grib processor to only accept certain grib messages.

<p>  
The options are then called for every grib message that is processed.
In the grib-processing phase, mode &ge; 0 and the mode will indicate the
verbosity level.  Mode == 0 is the lowest verbosity. and mode == 2
is normally the highest verbosity. These verbosity modes can be set by -v,
-v1 and -v2.  Modes 97, 98 and 99 are used in debugging.

<p>  
When the program has finished processing the grib data, the
option subroutines are called to cleanup the processing
(mode == -2). The
cleanup step is used to finish calculations (ex. averaging),
close files and free memory.  Freeing memory and closing files
may seem a wasted effort because the operating system will do that
when a program finishes.  However, wgrib2 is also a subroutine so
memory recovery and closing files is a must otherwise you
may run out of memory or file handles.
By the way, if you don't want a file closed, you can mark the file as persistant.


<h3>Custom Options</h3>

<p>
Writing your own option can be easy. That is why there
are so many options in wgrib2 (387 in 7/2022).  You just have
to follow some rules.

<h3>Setup: mode = -1</h3>
<p>
In the setup phase, you have to request services.  For
example if you want the grid point values or locations,
you set at flag in this step.
<p> You can also parse the arguments in the setup phase
or grib-processing step.  If you process the arguments
in setup phase will save time.  Processing the arguments
in the grib-processing step is necessary if the
processing depends on the grib message.  In addition,
macro options can only call options that have
no setup.  Here is an example of setting the options.

<pre>
extern decode, latlon, save_translation;
..
    if (mode == -1) {
        decode = 1;             /* decode the grid point values */
        latlon = 1;             /* calculate the lat lon values */
        save_tranlation = 1;    /* save the translation from external to internal scan order */
        return 0;
    }
</pre>

<h3>Setup: flags </h3>
<p>
The following flags request a service.  Set the flag to
one if you want the service.  Do not set the flag to zero because
another option may want the service.

<pre>
extern int decode             grid point values are decoded
extern int latlon             latitude and longitudes are calculated
extern int save_translation   save trnsalation from grib file to internal scan order
</pre>

<p>
Some flags are set by other options, and all options are expected
to obey the flag.  These flags may change.
<pre>
file_append                    Open an file for writing in append mode 
ieee_little_endian             if writing ieee, use little endian
header                         files use write in "header" mode
flush_mode                     flush the output after writes (all output files)
</pre>

<h3>Grib Processing: mode &ge; 0</h3>
<p>
In this phase, the option routine is called one
time each grib (sub)message is processed. The
routine has potential access (if requested) to the grid
point data and locations.  Of course, the routine
is not called if prevented by if/else/endif block.

<h3>Grib Processing: mode = -2</h3>
<p>
In the cleanup phase, calcuations, I/O are finished,
files are closed and allocated memory 

<h3>FILE I/O</h3>
<p>
Wgrib2 allows multiple options to read and write to a file.

</pre>
 $ wgrib2 IN.grb -if ':TMP:' -bin OUT.bin -endif -if ':HGT:' -bin OUT.bin -endif
</pre>

If each -bin option were allowed to open the file, the writes would
not work correctly.  So opening, closing, writing, reading and fseeks
have to be done by a special set of routines.

<pre>
    fopen_file(..)
    fclose_file(..)
    fread_file(..)
    fwrite_file(..)
    fseek_file(..)
    ftell_file(..)
    fflush_file(..)

    the only difference from the normal I/O is FILE *file is replaced by struct seq_file *file
</pre>

<h3>Static Variables</h3>
<p>
An option gets called for initialization, grib-processing, and cleanup.  So
the option routine needs static variables to retain information such
as the open file handles.  The situation is more difficult because an
option can be used more than once on a command line.

<pre>
 $ wgrib2 IN.grb -if ':TMP:' -bin TMP.bin -endif -if ':HGT:' -bin HGT.bin -endif
</pre>

So the option routine needs a set static variables for each use of the
option on the command line.  


<pre>
struct static_vars {
    struct seq_file out;
    int num_run;
}
...
    struct  static_vars *save;
    if (mode == -1) {
        decode = 1;
        *local = save = (struct static_vars *) malloc( sizeof(struct static_vars));
        /* local is defined as the subroutine argument, the i-th option on the command line
           is passed local[i] */
        if (save == NULL) fatal_error("memory allocation in XYZ);
        save->num_run = 0;
        if (fopen_file(&(save->out), arg1, "wb") != 0) fatal_error("open file %s", arg1);
        return 0;
    }
    save = *local;	/* *local is passed from calling routine */
    if (mode == -2) {
        fprintf(stderr,"XYZ called %d times\n", save->num);
        fclose(&(save->out));
        free(*local);
    }
    if (mode >= 0) {
        fwrite_file(data, ndata, sizeof(float), &(save->out));
        save->num_run += 1;
    }
    return 0; 
</pre>

<h3>Stdout</h3>
<p>
Normally options do not write to stdout but write their output to a buffer.
This allows the option routines to be called by other routines and return
a string value. For example,
you wanted the name of the variable. You can call the 
the <font color=red>-var</font> option, and the name would be returned
in the buffer.


<h3>Adding a New  Option</h3>
<p>
Adding a new option involves updating tables with
(1) option name and corresponding subroutine name,
(2) number of arguments the option takes and the
 (3) description of the option for the help command.
On a POSIX machine (has a POSIX shell and utilities),
the process is process is automatic.  You need to do,

<ol>
<li> The name of the source code needs to start with a capital letter
  and be written in C.
<li> Source code file needs to be added to grib2/wgrib2/    ex. grib2/wgrib2/File.c
<li> Each option needs a HEADER line
 <ul>
 <li>  ex. * HEADER:100:text:output:1:write text data into X
 <li> The line must start with '* HEADER:'
 <li> then a 3 digit number which display priority
 <li> then the name of the option, ex. 'text'
 <li> then comes the type of option, ex. 'output'
 <li> then by the number of arguments (only 0..8 are allowed)
 <li> finished by a description of the option
 </ul>
<li> The name of the routine associated with the option is int f_OPTION(ARGN)
<li> OPTION is replaced by the option name in the header line
<li> N is replaced by the number of arguments in the header line
<li> The script function.sh will read the header lines and generate fnlist.h and fnlist.c
</ol>






</td>
</tr>
<!--  End of Content area  -->
<!--   ...............................................Footer Portion.........................................    -->
 <tr>
  <td>
   <table width="500">
    <tr>
     <td colSpan="3"><hr></td>
    </tr>
    <TR vAlign="top">
     <TD class="gray">
      <A href="https://www.noaa.gov/" class="homepagelinks"><SPAN class="gray">NOAA/</SPAN></A>
      <A href="https://www.nws.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Weather Service</SPAN></A><BR>
      <A href="https://www.ncep.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Centers for Environmental Prediction</SPAN></a><BR>
        Climate Prediction Center<BR>
        5830 University Research Court<BR>
        College Park, Maryland 20740<BR>
      <A href="/comment-form.html" class="homepagelinks"><SPAN class="gray">Climate Prediction Center Web Team</SPAN></A><BR>
        Page last modified: May 15, 2005
     </TD>
     <TD>
      <A href="https://weather.gov/disclaimer.php" class="homepagelinks"><SPAN class="gray">Disclaimer</SPAN></A>
     </TD>
     <TD align="right">
      <A href="https://weather.gov/privacy.php" class="homepagelinks"> <SPAN class="gray">Privacy Policy</SPAN></A>
     </TD>
    </TR>
   </table>
  </td>
 </tr>
</table>
</td>
</tr>
</table>
</body>
</html>


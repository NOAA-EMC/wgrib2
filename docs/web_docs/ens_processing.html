<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>Climate Prediction Center - wgrib2: -ens_processing</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1252">
  <meta content="NCEP Web Team" name="GENERATOR">
  <meta name="keywords"
  content="Climate,Climate Prediction Center,National Weather Service,National Oceanic &amp; Atmospheric Administration, NOAA,El Nino,La Nina,ENSO,climate outlooks,El Nino Advisory,La Nina Advisory,droughts,hurricanes,Threats Assessment,Drought Assessment,Drought Monitor,CLimate Diagnostics Bulletin,6-10 day outlook,8-14 day outlook, 6-10 day forecast,8-14 day forecast,MRF,UV Index,North Atlantic Oscillation,NAO,Pacific Decadal Oscillation,PDO,sea surface temperatures,SST,Palmer Drought Severity Index, African Desk,outlooks,expert assessments,monitoring,advisories,stratosphere,temperature,precipitation,snow cover,snowfall,soil moisture,OLR,ozone,degree days,CLIMATE,CLIMATE PREDICTION CENTER,EL NINO,LA NINA, CLIMATE OUTLOOKS,HURRICANES,ASSESSMENTS,SNOW,STRATOSPHERE,DROUGHT,OZONE,DEGREE DAYS">
  <link href="/nwscwi/main.css" type="text/css" rel="STYLESHEET">
</head>
<body leftmargin="0" background="/nwscwi/background.gif" 
      topmargin="0" rightmargin="0" marginheight="0" marginwidth="0">
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/topbanner.jpg" border="0">
  <tr>
    <td align="right" height="19">
      <a href="#contents"><img height="1" alt="Skip Navigation Links"
         src="/nwscwi/skipgraphic.gif" width="1" border="0"></a>
      <a href="https://www.nws.noaa.gov/" class="homepagelinks"><span class="nwslink">www.nws.noaa.gov</span></a>&nbsp;</td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
  <tr>
    <td rowspan="2"><a href="https://www.noaa.gov/">
      <img height="78" alt="NOAA logo - Click to go to the NOAA home page"
      src="/nwscwi/noaaleft.jpg" width="85" border="0"></a></td>
    <td align="left"><img height="20" alt="National Weather Service"
      src="/nwscwi/nws_title.jpg" width="500" border="0"></td>
    <td rowspan="2" width="100%" background="/nwscwi/ncep_bkgrnd.jpg">&nbsp;</td>
    <td rowspan="2" align="right"><a href="https://www.nws.noaa.gov/">
      <img height="78" alt="NWS logo - Click to go to the NWS home page"
      src="/nwscwi/nwsright.jpg" width="85" border="0"></a></td>
  </tr>
  <tr>
    <td><img height="58" alt="Climate Prediction Center" src="/nwscwi/cpc.jpg"
             width="500" border="0"></td>    <!-- Put your center header image here. -->
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/navbkgrnd.gif" border="0">
  <tr>
    <td align="left" valign="top" width="94"><img height="23" alt="" src="/nwscwi/navbarleft.jpg" width
="94" border="0"></td>
    <td class="nav" align="center" width="15%">
      <a href="/products/site_index.html" class="menu">Site Map</a></td> <!-- Build a text only sitemap, and link to it via this
                                                    sitemap button just below the banner.
                                                    The sitemap should include a heirarchy of links
                                                    from NOAA, to the NWS, to NCEP, and then through your site. -->
    <td class="nav" align="right" width="15%">
      <a href="https://www.nws.noaa.gov/pa/" class="menu">News</a></td>
    <td class="nav" id="menuitem" align="right" width="20%">
      <a href="https://weather.gov/organization.php" class="menu">Organization</a></td>
    <td class="yellow" align="right" width="20%">
      <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
        <label for="search">Search</label>&nbsp;</td>
    <td align="left" class="searchinput" width="20%" nowrap>
      <input type="hidden" name="parsed" value="true">
      <input type="hidden" name="rn" value="3">
      <input type="hidden" name="in0" value="domain">
      <input type="hidden" name="dom0" value="nws.noaa.gov, weather.gov, wrh.noaa.gov, srh.noaa.gov, crh.noaa.gov, prh.noaa.gov, arh.noaa.gov, alaska.net/~nwsar, erh.noaa.gov, ncep.noaa.gov, wwb.noaa.gov, spc.noaa.gov, nhc.noaa.gov, sec.noaa.gov, aviationweather.gov, aviationweather.noaa.gov, weather.noaa.gov, roc.noaa.gov, nohrsc.nws.gov, nwstc.noaa.gov, wdtb.noaa.gov, npmoc.navy.mil, ndbc.noaa.gov">
      <input type="text" name="mw0" value="All NWS Search" id="search" size="20" maxlength="256">
      <input type="submit" name="Go2" value="Go"></td>
    <td width="10%">&nbsp;</form></td>
    <td align="right" valign="bottom" width="24"><img height="23" alt="" src="/nwscwi/navbarendcap.jpg"
 width="24" border="0"></td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="670" border="0">
  <tr valign="top">
    <td width="137"><br>
      <table cellspacing="0" cellpadding="2" width="137" border="0">
        <!-- Do not remove this section. You will need this when the City,St/zip search is implemented nationwide.-->
        <!-- <tr align="left" valign="top">
                <td class="searchinput">
                  <div id="Layer2" style="position:absolute; width:200px; height:115px; z-index:2; visibility: hidden">Search by city or zip code. Press enter or select the go button to submit request</div>
                  <form method="POST" action="https://www.srh.noaa.gov/zipcity.php">
                  <span class="yellow">Local forecast by<br>&quot;City, St&quot; or Zip Code</span><br>
                  <input type="text" name="inputstring" size="9" value="City, St">
                  <input type="submit" name="Go2" value="Go"></form></td>
        </tr> -->
         <tr>
          <td class="searchinput" align="left">
            <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
             <label for="search"><span class="yellow">CPC Search</span></label>
              <input type="hidden" name="parsed" value="true">
              <input type="hidden" name="rn" value="3">
              <input type="hidden" name="in0" value="domain">
              <input type="hidden" name="dom0" value="www.cpc.ncep.noaa.gov">
              <input type="text" name="mw0" id="search"  size="10" maxLength="256" value="CPC search">&nbsp;
              <input type="submit" name="Go2" value="Go">
          </form></td>
         </tr>
        <tr>
          <td class="white">
            <span class="yellow">About Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/mission.html" class="menu">Our Mission</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/" class="menu">Who We Are</a><br><br>
            <span class="yellow">Contact Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/personnel/contacts.html" class="menu">CPC Information</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/comment-form.html" class="menu">CPC Web Team</a><br><br>           
          </td>
        </tr>
      </table>
    </td>
    <td valign="top" align="center" width="533"><a name="contents"></a>

<!-- Begin content area -->

<table border="0" cellPadding="2" cellSpacing="0" align="center" width="533">
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
   <font face="Verdana,arial,serif" size="1"><a href="/index.html" class="homepagelinks"><strong>HOME</strong></a> &gt; <a href="/products/monitoring_and_data" class="homepagelinks">Monitoring_and_Data</a> &gt; <a href="/products/monitoring_and_data/oadata.html" class="homepagelinks">Oceanic and Atmospheric Data</a> &gt; <a href="/products/wesley/" class="homepagelinks">Reanalysis: Atmospheric Data</a> &gt; wgrib2-ens_processing</font>
  </td>
 </tr>
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
<font color=red>
<h3 align=center>wgrib2: -ens_processing</h3>
</font>


<h3>Introduction (wgrib2 v3.0.0)</h3>

<p>
Please don't use <font color=brown>-ens_processing</font>  with 
wgrib2 v2.0.8 because you get the wrong results if the number of threads
is not one when using a newer gcc compiler.  In addtion,
75% is inaccuracte, precip trace 
amounts (option = 1) is bad, and a possible seg fault could occur.  
(An out-of-bounds
array value is multipled by zero, so it doesn't affect the calculation.)
So you need to use wgrib2 v3.0.0+.

<p>
The <font color=brown>-ens_processing</font>  option takes
the ensemble member data and creates a pre-defined set of ensemble statistics.
If you want find the probability that a certain field has
values exceeding a limit, you should look at trick 65 in
the <a href='https://www.ftp.cpc.ncep.noaa.gov/wd51we/wgrib2/tricks.wgrib2'>
wgrib2 tricks page</a>.  

<p>
The <font color=brown>-ens_processing</font>  option is used
to create various ensemble statistics such as
minimum, maximum, average, spread, and various percentiles in order to describe the PDF.
The values are calculated with respect 
to all the ensemble members.  The calculations are different from the calculations 
used by the operational ensemble forecasts done at NCEP.  So fields like the various percentiles 
and spread will have different values from the NCEP operational products.
The results from the <font color=brown>-ens_processing</font>  option should not
be considered to be replacements for the official products because of the different
algorithms used.  (The exception will be the future climate reanalysis produced by CPC/NCEP.)

<p> The percentiles values were chosen because the future CPC/NCEP climate reanalysis (CORe)
will be using 80 ensemble members.  

<p>  The calculated variables are
<pre>
1) ensemble mean,  em = sum(x(i))/n,  i=1..n
2) ensemble spread, RMSE = sqrt(sum((x(i)-em)**2)/n)  note: n is used rather than n-1
3) minimum = minimum value over all ensemble members (for each grid point)
4) maximum = maximum value over all ensemble members (for each grid point)
5) 10 percentile
6) 25 percentile
7) 50 percentile (median)
8) 75 percentile
9) 90 percentile

Note: these calculations done when all the ensemble members have
values.  This will affect parameters like the cloud-top temperature
when some of the ensemble members are cloud free and have no cloud-
top temperatures. The -enq_qc calculates the ensemble mean and spread
ignoring the undefined values.

There are a few common ways to compute the percentile, wgrib2 uses a method
  recommended by NIST:

    https://www.itl.nist.gov/div898/handbook/prc/section2/prc262.htm

    percentile: sort values (1..N), p=percentile/100
           x(1) if p &le; 1/(N+1)
           x(p*(N+1)) if 1/(N+1) &le; p &le N/(N+1)
           x(N) if N/(N+1) &le; p &le; 1

           x(r) = x(floor(r))(1-(r-floor(r)) + x(floor(r)+1)(r-floor(r))
              for non-integral r

For the probabilities, a count is used to determine them.

As previously mentioned, the above calculations may differ from those used
in deriving the operational products.
</pre>

<p>  
The <font color=brown>-ens_processing</font> option was developed for the
future CORe reanalysis. For this reanalysis, additional fields 
are enabled by the second parameter set to "1".  However, users are warned 
that these fields are expected to change.  Generation of additional
fields can be enabled by setting the second parameter to special values.

<pre>
10) probability of precipitation &gt 0 *
11) probability of more than a trace of precipitation (trace=TBD) *
12) probability of 2m temperature greater than 273.15K *
13) 95 percentile for WIND at 10m above ground *

* optional, the definition of trace of precipitation is ad hoc
     trace can mean precipitation that will get the rain gauge wet but register as zero
     trace can mean less than 0.01 inches
     trace can mean less than 0.1 mm
     for wgrib2, trace = accumulated precip &lt 0.xxx mm, or a rate &lt 0.xxx mm/day.
</pre>

<p>
The <font color=brown>-ens_processing</font> is unlike most wgrib2
options in that this option can use large amounts of memory.  Suppose
that you have an 80 member ensemble and are processing the tmp500 field.
In order to calculate the percentiles of the tmp500, you need keep
all 80 tmp500 fields in memory. As the size of the grid and the number
of ensemble member increases, the required memory will increase.  

<h3>Code Table 4.3, Type of Generating Process</h3>
<p>Grib contains metadata, and one piece is the "generating process".
Wgrib2 tries its best to describe how the fields were created.  This
is documented in detail because if varies between PDT and center that
created the grib file.

<pre>
Ensemble mean, ensemble spread, ensemble minimum, ensemble maximum:
  Code Table 4.3 is preserved from the input file.

Percentiles, Probabilities:
  NCEP: code table 4.3 = 199,  Ensemble forecast based on counting
  Other centers: code table 4.3 = 4, Ensemble forecast

The NCEP files are more descriptive because an entry in a local table was
specially created for wgrib2.
</pre>


<h3>Definition of an Ensemble Member</h3>

<p>
Wgrib2 v3.0.0 defined an ensemble as having the same Product Definition Template (PDT=0, 1, 8, 11)
except for perturbation number.  The initial time and forecast times could be different as long
as the verification time was the same.  This allows lagged averge forecast (LAF) ensembles.
With wgrib2 v3.0.0, the type of ensemble forecast can be different.
(<a href="https://www.nco.ncep.noaa.gov/pmb/docs/grib2/grib2_doc/grib2_table4-6.shtml">code table 4.6</a>)
This means that  <font color=brown>-ens_processing</font>  can now work with a
combination of perturbed and control runs.
<p>
Limiting the PDTs to 0, 1, 8 and 11 is unnecessarily restrictive.  As a result,
<font color=brown>-ens_processing</font> does not work on aerosols, chemical
tracers and simulated satellite data from ensemble members.  

<h3>Order of Fields</h3>

The <font color=brown>-ens_processing</font> requires fields
to be in a specific order.  The data has to be processed
sequentially.  If the
<font color=brown>-ens_processing</font> finds a field that is
unlike the previous fields (except for ensemble member id), it
writes out the summary fields and starts processing a new variable.
The number id of the ensemble members is ignored, and is not
even necessary.

<pre>
bash-4.1$ wgrib2 all.grb | head -n 60
1:0:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+1
2:83628:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+2
3:164290:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+3
4:248531:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+4
..
19:1494083:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+19
20:1574514:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+20
21:1657406:d=2018020600:VIS:surface:84 hour fcst:ENS=+1
22:1703817:d=2018020600:VIS:surface:84 hour fcst:ENS=+2
..
39:2488331:d=2018020600:VIS:surface:84 hour fcst:ENS=+19
40:2533546:d=2018020600:VIS:surface:84 hour fcst:ENS=+20
41:2579586:d=2018020600:UGRD:planetary boundary layer:84 hour fcst:ENS=+1
42:2629955:d=2018020600:UGRD:planetary boundary layer:84 hour fcst:ENS=+2
..
</pre>
<h3>Order of Fields: gmerge to the rescue</h3>

<p>  The <font color=brown>-ens_processing</font> requires the
fields to be in a specific order (or processed in a specific order).
Suppose we have forecasts from 3 ensemble members in files fcst1, fcst2
and fcst3.  Now we are going to require that the fields have the
same order in these files, and the files have no submessages.
Then we can combine these files using gmerge, the resulting file
will be in the correct order. (Gmerge has been included with wgrib2
source code for many years.)  There is a minor restriction, gmerge 
doesn't handle grib files which includes non-grib data.

<pre>
gmerge output fcst1 fcst2 fcst3
</pre>

The requirements for output to be in the right order.

<ol>
<li> fcstX must have fields in the same order
<li> number of forecasts &le 200 for wgrib2 v2.0.8 distribution
<li> fcstX must not use submessages
<li> the like forecasts must have same PDT except for ensemble number
<li> the ensemble number is optional
<li> no non-grib data in grib file
</ol>

You can find gmerge in the wgrib2 public distrbution under the aux_progs directory.
If your initial files are not in identical order, you could combine the forecasts
and sort the fields so that like fields are adjacent. However, sorting the individual
forecasts and then running gmerge would probably be faster.


<p> Now that "output" has the data in the correct order, the
option <font color=brown>-ens_processing</font> can be used to
create the min/max/ave/spread of the ensemble.

<pre>
gmerge  output1 fcst1 fcst2 fcst3
wgrib2  output1 -ens_processing output2 x
  note: x is a dummy argument, it may be used in the future

For faster processing, we can replace the disk file "output" by a pipe.
This method may or may not work under Windows.


gmerge - fcst1 fcst2 fcst3 | wgrib2 - -ens_processing output x

    gmerge - A B C   writes the output to stdout (denoted by the -)
    wgrib2 - (..)    reads the input grib data from stdin (denoted by the -)

NOTE 1: must use a recent version of gmerge.  Old versions of gmerge
only accepted a small number of input files and did not allow
output to the pipe by "-".

NOTE 2: a common unix convention is that the "-" instead of a file name
represents either stdin or stdout.  By knowing the program arguements, 
one can determine whether the dash is stdin or stdout.  Wgrib2 uses
this convention in most places that require a file name.
</pre>

<h3>Fast Processing at the expense of Large Memory</h3>

<p>
Using gmerge, and sending the output to wgrib2 is simple.  However, it
can be I/O inefficient especially for large ensembles.  Consider a
small system that has 80 ensemble member data on one drive.  For the 1st
field, the system has to read field-1 of file-1.  For the second field,
the system has to read field-1 from file-2.  For the 81st field, the
system has to read field-2 from file-1.  Hopefully the disk cache was
big enough that the field-2 of file-1 was still cached.  The speed of
processing depends on the size of disk cache. This example is for
a small system, what would happen on a HPC system?  Disk cache is
much larger but so is the block size.  If one job takes a large fraction
of the disk cache, the other jobs will be much more disk inefficient.

<p> A better approach is to adopt the technique used in 
<a href="./ave.html">fast averaging</a>.  You may be
limited by the amount of physical memory on the system.

<pre>
cat fcst.2018122600.mem* | wgrib2 - -set_grib_type c3 \
  -if (xxx1) -ens_processing out 0 -fi \
  -if (xxx2) -ens_proceesing out 0 -fi \
  ...
  -if (xxxN) -ens_proceesing out 0 -fi
</pre>

This approach only has two open files at any one time, and
the files are read and written sequentially.  This approach is
harder to program but is much more I/O friendly for both workstations
and HPCs.  The drawback is that this approach needs to keep all
the fields in memory.  (#ensemble members x #fields/file x NX x NY x 4 bytes).


<h3>Usage</h3>
<p>

<pre>
-ens_processing FILE Option
   FILE = output file, grib2 format
   Option = 0   default
            1   include probabilities (TMP2m, precip)
                note: option 1 is intended for use by the future
		<b>C</b>onventional <b>O</b>bservation <b>RE</b>analysis
		(CORe).  The output will be determined the needs of this
                reanalysis. 
            2   for future use or different output.

  If you would like to add more output from -ens_processing, it
  needs to be enabled by an option number.  Ask me (WNE) for
  a number.
</pre>

<h3>Example</h3>
<p>
<pre>
$ <font color=brown>wgrib2 input -ens_processing output 0 </font>
1:0:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+1
2:83628:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+2
3:164290:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+3
4:248531:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+4
5:331723:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+5
6:412226:d=2018020600:PRES:mean sea level:84 hour fcst:ENS=+6
..
$ <font color=brown>wgrib2 output</font>
1:0:d=2018020600:PRES:mean sea level:84 hour fcst:min all members
2:130501:d=2018020600:PRES:mean sea level:84 hour fcst:max all members
3:261002:d=2018020600:PRES:mean sea level:84 hour fcst:ens mean
4:391503:d=2018020600:PRES:mean sea level:84 hour fcst:ens spread
5:497569:d=2018020600:PRES:mean sea level:84 hour fcst:25%-75% range
6:611780:d=2018020600:PRES:mean sea level:84 hour fcst:10% all members
7:742281:d=2018020600:PRES:mean sea level:84 hour fcst:90% all members
8:872782:d=2018020600:VIS:surface:84 hour fcst:min all members
9:938123:d=2018020600:VIS:surface:84 hour fcst:max all members
...
</pre>

<h3>GrADS</h3>

<p>  At the time of writing (1/2018), the files that
are produced by
 <font color=brown>-ens_processing</font>  cannot be displayed
using the g2ctl/gribmap/GrADS set of programs.  However, they
can be displayed by atl_g2ctl/alt_gmp/GrADS set of programs.

<pre>
  alt_g2ctl -short output >output.ctl
  alt_gmp output.ctl
  grads
</pre>

<p>
See also: 
<a href="./ens_qc.html">-ens_qc</a>

</td>
</tr>


<!--  End of Content area  -->
<!--   ...............................................Footer Portion.........................................    -->
 <tr>
  <td>
   <table width="500">
    <tr>
     <td colSpan="3"><hr></td>
    </tr>
    <TR vAlign="top">
     <TD class="gray">
      <A href="https://www.noaa.gov/" class="homepagelinks"><SPAN class="gray">NOAA/</SPAN></A>
      <A href="https://www.nws.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Weather Service</SPAN></A><BR>
      <A href="https://www.ncep.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Centers for Environmental Prediction</SPAN></a><BR>
        Climate Prediction Center<BR>
        5830 University Research Court<BR>
        College Park, Maryland 20740<BR>
      <A href="/comment-form.html" class="homepagelinks"><SPAN class="gray">Climate Prediction Center Web Team</SPAN></A><BR>
        Page last modified: Jan 18, 2018, Aug 29, 2018, June 21, 2019, Sep 24, 2019. Jan 2021, Jan 2022, July 2023
     </TD>
     <TD>
      <A href="https://weather.gov/disclaimer.php" class="homepagelinks"><SPAN class="gray">Disclaimer</SPAN></A>
     </TD>
     <TD align="right">
      <A href="https://weather.gov/privacy.php" class="homepagelinks"> <SPAN class="gray">Privacy Policy</SPAN></A>
     </TD>
    </TR>
   </table>
  </td>
 </tr>
</table>
</td>
</tr>
</table>
</body>
</html>


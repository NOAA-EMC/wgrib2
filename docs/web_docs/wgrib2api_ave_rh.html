<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>Climate Prediction Center - wgrib2api</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1252">
  <meta content="NCEP Web Team" name="GENERATOR">
  <meta name="keywords"
  content="Climate,Climate Prediction Center,National Weather Service,National Oceanic &amp; Atmospheric Administration, NOAA,El Nino,La Nina,ENSO,climate outlooks,El Nino Advisory,La Nina Advisory,droughts,hurricanes,Threats Assessment,Drought Assessment,Drought Monitor,CLimate Diagnostics Bulletin,6-10 day outlook,8-14 day outlook, 6-10 day forecast,8-14 day forecast,MRF,UV Index,North Atlantic Oscillation,NAO,Pacific Decadal Oscillation,PDO,sea surface temperatures,SST,Palmer Drought Severity Index, African Desk,outlooks,expert assessments,monitoring,advisories,stratosphere,temperature,precipitation,snow cover,snowfall,soil moisture,OLR,ozone,degree days,CLIMATE,CLIMATE PREDICTION CENTER,EL NINO,LA NINA, CLIMATE OUTLOOKS,HURRICANES,ASSESSMENTS,SNOW,STRATOSPHERE,DROUGHT,OZONE,DEGREE DAYS">
  <link href="/nwscwi/main.css" type="text/css" rel="STYLESHEET">
</head>
<body leftmargin="0" background="/nwscwi/background.gif" 
      topmargin="0" rightmargin="0" marginheight="0" marginwidth="0">
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/topbanner.jpg" border="0">
  <tr>
    <td align="right" height="19">
      <a href="#contents"><img height="1" alt="Skip Navigation Links"
         src="/nwscwi/skipgraphic.gif" width="1" border="0"></a>
      <a href="https://www.nws.noaa.gov/" class="homepagelinks"><span class="nwslink">www.nws.noaa.gov</span></a>&nbsp;</td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
  <tr>
    <td rowspan="2"><a href="https://www.noaa.gov/">
      <img height="78" alt="NOAA logo - Click to go to the NOAA home page"
      src="/nwscwi/noaaleft.jpg" width="85" border="0"></a></td>
    <td align="left"><img height="20" alt="National Weather Service"
      src="/nwscwi/nws_title.jpg" width="500" border="0"></td>
    <td rowspan="2" width="100%" background="/nwscwi/ncep_bkgrnd.jpg">&nbsp;</td>
    <td rowspan="2" align="right"><a href="https://www.nws.noaa.gov/">
      <img height="78" alt="NWS logo - Click to go to the NWS home page"
      src="/nwscwi/nwsright.jpg" width="85" border="0"></a></td>
  </tr>
  <tr>
    <td><img height="58" alt="Climate Prediction Center" src="/nwscwi/cpc.jpg"
             width="500" border="0"></td>    <!-- Put your center header image here. -->
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="100%" background="/nwscwi/navbkgrnd.gif" border="0">
  <tr>
    <td align="left" valign="top" width="94"><img height="23" alt="" src="/nwscwi/navbarleft.jpg" width
="94" border="0"></td>
    <td class="nav" align="center" width="15%">
      <a href="/products/site_index.html" class="menu">Site Map</a></td> <!-- Build a text only sitemap, and link to it via this
                                                    sitemap button just below the banner.
                                                    The sitemap should include a heirarchy of links
                                                    from NOAA, to the NWS, to NCEP, and then through your site. -->
    <td class="nav" align="right" width="15%">
      <a href="https://www.nws.noaa.gov/pa/" class="menu">News</a></td>
    <td class="nav" id="menuitem" align="right" width="20%">
      <a href="https://weather.gov/organization.php" class="menu">Organization</a></td>
    <td class="yellow" align="right" width="20%">
      <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
        <label for="search">Search</label>&nbsp;</td>
    <td align="left" class="searchinput" width="20%" nowrap>
      <input type="hidden" name="parsed" value="true">
      <input type="hidden" name="rn" value="3">
      <input type="hidden" name="in0" value="domain">
      <input type="hidden" name="dom0" value="nws.noaa.gov, weather.gov, wrh.noaa.gov, srh.noaa.gov, crh.noaa.gov, prh.noaa.gov, arh.noaa.gov, alaska.net/~nwsar, erh.noaa.gov, ncep.noaa.gov, wwb.noaa.gov, spc.noaa.gov, nhc.noaa.gov, sec.noaa.gov, aviationweather.gov, aviationweather.noaa.gov, weather.noaa.gov, roc.noaa.gov, nohrsc.nws.gov, nwstc.noaa.gov, wdtb.noaa.gov, npmoc.navy.mil, ndbc.noaa.gov">
      <input type="text" name="mw0" value="All NWS Search" id="search" size="20" maxlength="256">
      <input type="submit" name="Go2" value="Go"></td>
    <td width="10%">&nbsp;</form></td>
    <td align="right" valign="bottom" width="24"><img height="23" alt="" src="/nwscwi/navbarendcap.jpg"
 width="24" border="0"></td>
  </tr>
</table>
<table cellspacing="0" cellpadding="0" width="670" border="0">
  <tr valign="top">
    <td width="137"><br>
      <table cellspacing="0" cellpadding="2" width="137" border="0">
        <!-- Do not remove this section. You will need this when the City,St/zip search is implemented nationwide.-->
        <!-- <tr align="left" valign="top">
                <td class="searchinput">
                  <div id="Layer2" style="position:absolute; width:200px; height:115px; z-index:2; visibility: hidden">Search by city or zip code. Press enter or select the go button to submit request</div>
                  <form method="POST" action="https://www.srh.noaa.gov/zipcity.php">
                  <span class="yellow">Local forecast by<br>&quot;City, St&quot; or Zip Code</span><br>
                  <input type="text" name="inputstring" size="9" value="City, St">
                  <input type="submit" name="Go2" value="Go"></form></td>
        </tr> -->
         <tr>
          <td class="searchinput" align="left">
            <form action="https://www.firstgov.gov/fgsearch/index.jsp" name="query">
             <label for="search"><span class="yellow">CPC Search</span></label>
              <input type="hidden" name="parsed" value="true">
              <input type="hidden" name="rn" value="3">
              <input type="hidden" name="in0" value="domain">
              <input type="hidden" name="dom0" value="www.cpc.ncep.noaa.gov">
              <input type="text" name="mw0" id="search"  size="10" maxLength="256" value="CPC search">&nbsp;
              <input type="submit" name="Go2" value="Go">
          </form></td>
         </tr>
        <tr>
          <td class="white">
            <span class="yellow">About Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/mission.html" class="menu">Our Mission</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/who_we_are/" class="menu">Who We Are</a><br><br>
            <span class="yellow">Contact Us</span><br>
            &nbsp;&nbsp;&nbsp;<a href="/information/personnel/contacts.html" class="menu">CPC Information</a><br>
            &nbsp;&nbsp;&nbsp;<a href="/comment-form.html" class="menu">CPC Web Team</a><br><br>           
          </td>
        </tr>
      </table>
    </td>
    <td valign="top" align="center" width="533"><a name="contents"></a>

<!-- Begin content area -->

<table border="0" cellPadding="2" cellSpacing="0" align="center" width="533">
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
   <font face="Verdana,arial,serif" size="1"><a href="/index.html" class="homepagelinks"><strong>HOME</strong></a> &gt; <a href="/products/monitoring_and_data" class="homepagelinks">Monitoring_and_Data</a> &gt; <a href="/products/monitoring_and_data/oadata.html" class="homepagelinks">Oceanic and Atmospheric Data</a> &gt; <a href="/products/wesley/" class="homepagelinks">Reanalysis: Atmospheric Data</a> &gt; wgrib2api ave_rh.f90</font>
  </td>
 </tr>
 <tr><td>&nbsp;</td></tr>
 <tr>
  <td>
<font color=red>
<h3 align=center>wgrib2api ave_rh.f90</h3>
<h3 align=center>Example: calculating average RH from surface to 700 mb</h3>
</font>


<h3>Introduction</h3>

<p>
The wgrib2 utility can do calculations but some calculations are
more easily done in Fortran.  This example came from a user question
on how to calculate the average RH from the surface to 700 mb.  I 
am using a sample file with the surface pressure, RH for the levels,
1000, 925, 850 and 700 mb.  The proper tool for the job is wgrib2api.


<font color="blue">
<pre>
     1	! 1/2018 Public Domain Wesley Ebisuzaki
     2	!
     3	!	Compute average rh from surface to 700 mb and write as grib file
     4	!
     5	!       input: grib file with RH on 1000, 925 850 and 700 mb
     6	!       output: grib file with pressure weighted average RH from
     7	!           surface to 700 mb
     8	!
     9	!       files:
    10	!           in = input grib2 file that has 1000, 825, 850 and 700 mb RH
    11	!                   (only one field at each level)
    12	!           inv = inventory file
    13	!           out = output grib2 with average RH
    14	!
    15	!       For RH below 1000 mb, use 1000 mb value
    16	!
    17	!       requires: wgrib2api built with wgrib2 v2.0.8 which supports
    18	!          'surface - 700 mb'
    19	!          grb_UNDEFINED
    20	!
    21	        use wgrib2api
    22	        character (len=100) :: in, out, inv
    23	        character (len=200) :: metadata
    24	        real, allocatable :: sfc_prs(:,:), tmp(:,:), rh(:,:,:), ave_rh(:,:)
    25	        integer, parameter :: nlevs = 4
    26		real, dimension (0:nlevs), parameter :: levels = (/ 2000.0, 1000.0, 925.0, 850.0, 700.0 /)
    27	        character (len=9), dimension(0:nlevs), parameter :: &
    28	            txt_levs = (/ ':2000 mb:', ':1000 mb:', ':925 mb: ', ':850 mb: ', ':700 mb: ' /)
    29	        character (len=30), parameter :: out_level = 'surface - 700 mb'
    30	
    31		integer :: lev, nx, ny, i, j
    32		real:: factor, ave_val, lower_val
    33	
    34		in='/export/cpc-lw-webisuzak/wd51we/grib2/examples/gep19.aec'
    35		inv='gep19.aec.inv'
    36		out='ave_rh.grb'
    37	
    38	!	make inventory
    39		i = grb2_mk_inv(in,inv)
    40		if (i /= 0) stop 1
    41	
    42	!	read surface pressure
    43		i = grb2_inq(in, inv, ':PRES:', ':surface:', data2=sfc_prs, nx=nx, ny=ny)
    44		if (i /= 1) stop 2
    45		sfc_prs = 0.01 * sfc_prs		! convert from Pa to mb
    46		write(*,*) 'read sfc pressure (mb) done'
    47	
    48	!	read rh 
    49		allocate(rh(nx,ny,0:nlevs))
    50		do lev = 1, nlevs
    51		   i = grb2_inq(in, inv, ':RH:', txt_levs(lev), data2=tmp, desc=metadata)
    52		   if (i /= 1) stop 3
    53		   rh(:,:,lev) = tmp
    54		enddo
    55		rh(:,:,0) = rh(:,:,1)			! rh(2000mb) = rh(1000mb)
    56		write(*,*) 'read rh finished'
    57	
    58	!	now find the ave RH, surface-700 mb, pressure weighted
    59		allocate(ave_rh(nx,ny))
    60		ave_rh = 0.0
    61		do j = 1, ny
    62		    do i = 1, nx
    63			if (sfc_prs(i,j).gt.2000) stop 4
    64			if (sfc_prs(i,j).lt.levels(nlevs)) then
    65	        	    ave_rh(i,j) = grb2_UNDEFINED
    66			    cycle
    67			endif
    68			do lev = 1, nlevs
    69			    if (sfc_prs(i,j) .gt. levels(lev-1)) then
    70	!			include whole layer
    71				ave_rh(i,j) = ave_rh(i,j) + (rh(i,j,lev-1)+rh(i,j,lev))*0.5*(levels(lev-1)-levels(lev))
    72			    else if (sfc_prs(i,j) .gt. levels(lev)) then
    73	!			include partial layer
    74				factor = (sfc_prs(i,j)-levels(lev)) / (levels(lev-1) - levels(lev))
    75				lower_val = factor*rh(i,j,lev-1) + (1.0-factor)*rh(i,j,lev)
    76			        ave_val = 0.5*(lower_val + rh(i,j,lev))
    77				ave_rh(i,j) = ave_rh(i,j) + ave_val * (sfc_prs(i,j) - levels(lev))
    78			    endif
    79			enddo
    80	!	        normalize ave_rh 
    81			ave_rh(i,j) = ave_rh(i,j) / (sfc_prs(i,j) - levels(nlevs))
    82		    enddo
    83		enddo
    84	
    85	!	write ave_rh
    86		i = grb2_wrt(out,in,1,data2=ave_rh,meta=metadata,level=out_level)
    87		if (i /= 0) stop 5
    88	
    89		stop
    90		end
</pre>
</font>
<pre>
line 21:     needed use wgrib2api
lines 38-40: make inventory file
lines 42-46: read surface pressure, get nx, ny of the grid
lines 48-56: read RH for 1000, 925, 850 and 700 mb
             save in RH(:,:,level)
             for computations make RH for 2000 mb for the case
              where surface pressure is greater than 1000 mb.
lines 58-83: compute surface-700 mb average RH.
line 63:     if surface pressure is 2000 mb, something is really wrong
lines 64-67: if surface pressure is less than 700, ave RH is undefined
              note: grib2_UNDEFINED requires wgrib2api v2.0.7
lines 68-79: contribution of each layer to ave_rh
lines 85-87: write out ave_rh
              note: level_out requires wgrib2api v2.0.7
</pre>

<h3>Comments</h3>

<p>
I needed to add couple of fixes to wgrib2 to make this example work. First
I added grb2_UNDEFINED and grb2_DEFINED_VAL(x) to wgrib2api. Next I had
to enhance wgrib2 so that -set_lev would handle "surface - 700 mb".

<p>
In the fortran code, reading and writing grib2 is done is a simple
manner. 

<h3>Code</h3>

<a href="https://ftp.cpc.ncep.noaa.gov/wd51we/wgrib2api/ave_rh/ave_rh.f90">ave_rh.f90</a>

</ol>
</td>
</tr>


<!--  End of Content area  -->
<!--   ...............................................Footer Portion.........................................    -->
 <tr>
  <td>
   <table width="500">
    <tr>
     <td colSpan="3"><hr></td>
    </tr>
    <TR vAlign="top">
     <TD class="gray">
      <A href="https://www.noaa.gov/" class="homepagelinks"><SPAN class="gray">NOAA/</SPAN></A>
      <A href="https://www.nws.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Weather Service</SPAN></A><BR>
      <A href="https://www.ncep.noaa.gov/" class="homepagelinks"><SPAN class="gray">National Centers for Environmental Prediction</SPAN></a><BR>
        Climate Prediction Center<BR>
        5830 University Research Court<BR>
        College Park, Maryland 20740<BR>
      <A href="/comment-form.html" class="homepagelinks"><SPAN class="gray">Climate Prediction Center Web Team</SPAN></A><BR>
        Page last modified: Jan 25, 2018
     </TD>
     <TD>
      <A href="https://weather.gov/disclaimer.php" class="homepagelinks"><SPAN class="gray">Disclaimer</SPAN></A>
     </TD>
     <TD align="right">
      <A href="https://weather.gov/privacy.php" class="homepagelinks"> <SPAN class="gray">Privacy Policy</SPAN></A>
     </TD>
    </TR>
   </table>
  </td>
 </tr>
</table>
</td>
</tr>
</table>
</body>
</html>

